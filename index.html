<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sanitary & Storm Drain Calculator</title>

<!-- jsPDF and autotable for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#2563eb;
  --primary-dark:#1d4ed8;
  --secondary:#64748b;
  --light:#f8fafc;
  --dark:#0f172a;
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
  --border:#cbd5c1;
}
body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f1f5f9;color:var(--dark);padding:20px}
.container{max-width:1200px;margin:0 auto}
header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:20px;border-radius:10px;margin-bottom:20px}
h1{font-size:1.8rem;margin:0}
.subtitle{opacity:.9;margin-top:6px}
.disclaimer{background:#fff3cd;border:1px solid #ffeaa7;padding:10px;border-radius:6px;margin-top:10px;color:#000} /* changed to black */
.tabs{display:flex;border-bottom:1px solid var(--border);gap:6px;flex-wrap:wrap;margin-bottom:12px}
.tab{padding:8px 14px;cursor:pointer;border-bottom:3px solid transparent}
.tab.active{border-bottom:3px solid var(--primary);font-weight:600;color:var(--primary)}
.tab-content{display:none}
.tab-content.active{display:block}
.section{background:#fff;padding:18px;border-radius:8px;border:1px solid var(--border);margin-bottom:18px}
.form-row{display:flex;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
.form-row label{flex:0 0 190px;font-weight:600;text-align:right}
.input-group{flex:1;display:flex;gap:8px;align-items:center}
.input-group input,.input-group select{flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);min-width:0}
.unit{flex:0 0 70px;font-weight:600}
.button-group{display:flex;gap:10px;margin-top:10px}



button{padding:10px 14px;border-radius:6px;border:none;background:var(--primary);color:#fff;cursor:pointer}
button.secondary{background:var(--secondary)}
.output{margin-top:12px;padding:12px;border-radius:6px;background:#f8fafe;border-left:4px solid var(--primary);display:none}
.pipe-cost-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.size-select{width:90px}
.cost-input{width:130px}
.add-pipe-btn{background:var(--success);color:#fff;padding:8px;border-radius:6px;border:none}
.remove-pipe-btn{background:var(--danger);color:#fff;padding:6px;border-radius:6px;border:none}
.summary-card{background:#fff;padding:14px;border-radius:8px;margin-bottom:12px;border:1px solid var(--border);display:none}
.reference-table{width:100%;border-collapse:collapse;margin-top:10px}
.reference-table th,.reference-table td{padding:8px;border:1px solid #ddd}
.formula{font-family:monospace;background:#f8fafc;padding:8px;border-radius:6px;border-left:3px solid var(--primary)}
.grey-header{background:#e0e0e0;font-weight:bold}
.hidden-file{display:none}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Sanitary & Storm Drain Calculator</h1>
    <div class="subtitle">Quantity takeoff for plumbing contractors & estimators — metric & imperial</div>
    <div class="disclaimer">
      <strong>Note:</strong> This calculator uses practical approximations. For formal design, consult local codes and a licensed engineer.
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="project">Project Info</div>
    <div class="tab" data-tab="sanitary">Sanitary System</div>
    <div class="tab" data-tab="storm">Storm System</div>
    <div class="tab" data-tab="costs">Costs & Labor</div>
    <div class="tab" data-tab="summary">Summary & Export</div>
    <div class="tab" data-tab="help">Help & Formulas</div>
  </div>

  <!-- Project Info -->
  <div id="project" class="tab-content active">
    <div class="section">
      <h2>Project Information</h2>
      <div class="form-row">
        <label>Project Name:</label>
        <div class="input-group"><input id="projectName" type="text" value="Residential Plumbing Project"></div>
      </div>
      <div class="form-row">
        <label>Client Name:</label>
        <div class="input-group"><input id="clientName" type="text" value="John Dela Cruz"></div>
      </div>
      <div class="form-row">
        <label>Location:</label>
        <div class="input-group"><input id="projectLocation" type="text" value="Manila, Philippines"></div>
      </div>
      <div class="form-row">
        <label>Prepared By:</label>
        <div class="input-group"><input id="preparedBy" type="text" value="Maria Santos, Civil Engineer"></div>
      </div>
      <div class="form-row">
        <label>Currency:</label>
        <div class="input-group">
          <select id="currency"><option value="PHP">Philippine Peso (₱)</option><option value="USD">US Dollar ($)</option><option value="EUR">Euro (€)</option><option value="JPY">Yen (¥)</option></select>
        </div>
      </div>
      <div class="form-row">
        <label>Plumbing Code Standard:</label>
        <div class="input-group">
          <select id="codeStandard"><option value="mpcp">RNPCP (Philippines)</option><option value="ipc">IPC</option><option value="upc">UPC</option></select>
        </div>
      </div>
      <div class="form-row">
        <label>Measurement Units:</label>
        <div class="input-group">
          <select id="units"><option value="metric">Metric (m, mm, L/s)</option><option value="imperial">Imperial (ft, in, gpm)</option></select>
        </div>
      </div>

      <div class="button-group">
        <button onclick="saveProjectAsJSON()">Save Project (JSON)</button>
        <button class="secondary" onclick="document.getElementById('jsonFileInput').click()">Load Project (JSON)</button>
        <input id="jsonFileInput" type="file" accept=".json,application/json" class="hidden-file" onchange="loadProjectFromJSON(event)">
        <button class="secondary" onclick="resetCalculator()" style="background-color:var(--danger)">Reset</button>
      </div>
    </div>
  </div>

  <!-- Sanitary System -->
  <div id="sanitary" class="tab-content">
    <div class="section">
      <h2>Sanitary System</h2>
      <h3>Fixture Count</h3>
      <div class="form-row"><label>Water Closets:</label><div class="input-group"><input id="wc" type="number" min="0" value="2"></div></div>
      <div class="form-row"><label>Lavatories:</label><div class="input-group"><input id="lav" type="number" min="0" value="2"></div></div>
      <div class="form-row"><label>Kitchen Sinks:</label><div class="input-group"><input id="sink" type="number" min="0" value="1"></div></div>
      <div class="form-row"><label>Showers:</label><div class="input-group"><input id="shower" type="number" min="0" value="1"></div></div>
      <div class="form-row"><label>Bathtubs:</label><div class="input-group"><input id="tub" type="number" min="0" value="1"></div></div>
      <div class="form-row"><label>Urinals:</label><div class="input-group"><input id="urinal" type="number" min="0" value="0"></div></div>
      <div class="form-row"><label>Floor Drains:</label><div class="input-group"><input id="floorDrain" type="number" min="0" value="2"></div></div>

      <h3>Pipe Systems</h3>
      <div class="form-row">
        <label>Total Developed Length:</label>
        <div class="input-group">
          <input id="sanLength" type="number" min="0" step="0.1" value="50">
          <div class="unit" id="sanLengthUnit">m</div>
        </div>
      </div>
      <div class="form-row">
        <label>Pipe Material:</label>
        <div class="input-group">
          <select id="sanPipeMaterial"><option value="pvc">PVC</option><option value="castiron">Cast Iron</option><option value="hdp">HDPE</option><option value="abs">ABS</option></select>
        </div>
      </div>
      <div class="form-row">
        <label>Commercial Pipe Length:</label>
        <div class="input-group"><select id="sanPipeLength"><option value="3">3 m</option><option value="6" selected>6 m</option></select></div>
      </div>
      <div class="form-row">
        <label>Pipe Slope (%):</label>
        <div class="input-group"><input id="sanSlope" type="number" min="0.5" max="10" step="0.1" value="2"></div>
      </div>

      <div class="button-group">
        <button onclick="calculateSanitary()">Calculate Sanitary System</button>
      </div>
      <div id="sanitaryOutput" class="output"></div>
    </div>
  </div>

  <!-- Storm System -->
  <div id="storm" class="tab-content">
    <div class="section">
      <h2>Storm Drain System</h2>
      <h3>Runoff Calculation</h3>
      <div class="form-row">
        <label>Roof Area:</label>
        <div class="input-group"><input id="roofArea" type="number" min="0" step="0.1" value="200"><div class="unit" id="roofAreaUnit">m²</div></div>
      </div>
      <div class="form-row">
        <label>Pavement Area:</label>
        <div class="input-group"><input id="pavementArea" type="number" min="0" step="0.1" value="0"><div class="unit" id="pavementAreaUnit">m²</div></div>
      </div>
      <div class="form-row">
        <label>Runoff Coefficient (C):</label>
        <div class="input-group"><input id="coef" type="number" min="0.1" max="1" step="0.05" value="0.9"></div>
      </div>
      <div class="form-row">
        <label>Rainfall Intensity:</label>
        <div class="input-group"><input id="intensity" type="number" min="0" step="0.1" value="50"><div class="unit" id="intensityUnit">mm/hr</div></div>
      </div>

      <h3>Pipe Systems</h3>
      <div class="form-row">
        <label>Total Developed Length:</label>
        <div class="input-group"><input id="stormLength" type="number" min="0" step="0.1" value="60"><div class="unit" id="stormLengthUnit">m</div></div>
      </div>
      <div class="form-row">
        <label>Pipe Material:</label>
        <div class="input-group"><select id="stormPipeMaterial"><option value="pvc">PVC</option><option value="corrugated">Corrugated HDPE</option><option value="concrete">Concrete</option><option value="castiron">Cast Iron</option></select></div>
      </div>
      <div class="form-row">
        <label>Commercial Pipe Length:</label>
        <div class="input-group"><select id="stormPipeLength"><option value="3">3 m</option><option value="6" selected>6 m</option></select></div>
      </div>

      <div class="form-row">
        <label>Pipe Slope (%):</label>
        <div class="input-group"><input id="stormSlope" type="number" min="0.5" max="10" step="0.1" value="1"></div>
      </div>

      <div class="button-group">
        <button onclick="calculateStorm()">Calculate Storm Drain System</button>
      </div>
      <div id="stormOutput" class="output"></div>
    </div>
  </div>

  <!-- Costs & Labor -->
  <div id="costs" class="tab-content">
    <div class="section">
      <h2>Costs & Labor Estimations</h2>

      <div class="material-costs">
        <h3>Material Costs</h3>
        <div>
          <h4>Sanitary Systems</h4>
          <div id="sanitaryPipesContainer"></div>
          <button class="add-pipe-btn" onclick="addSanitaryPipe()">+ Add Pipe</button>
        </div>
        <div style="margin-top:12px">
          <h4>Storm Drain System</h4>
          <div id="stormPipesContainer"></div>
          <button class="add-pipe-btn" onclick="addStormPipe()">+ Add Pipe</button>
        </div>

        <div style="margin-top:12px">
          <h4>Accessories (unit cost)</h4>
          <div class="form-row"><label>Trap Cost (each):</label><div class="input-group"><input id="trapCost" type="number" min="0" step="0.01" value="150"></div></div>
          <div class="form-row"><label>Vent Cost (each):</label><div class="input-group"><input id="ventCost" type="number" min="0" step="0.01" value="100"></div></div>
          <div class="form-row"><label>Cleanout Cost (each):</label><div class="input-group"><input id="cleanoutCost" type="number" min="0" step="0.01" value="200"></div></div>
          <div class="form-row"><label>Manhole Cost (each):</label><div class="input-group"><input id="manholeCost" type="number" min="0" step="0.01" value="5000"></div></div>
          <div class="form-row"><label>Fitting/Elbow Cost (each):</label><div class="input-group"><input id="fittingCost" type="number" min="0" step="0.01" value="80"></div></div>
          <div class="form-row"><label>Downspout Cost (each):</label><div class="input-group"><input id="downspoutCost" type="number" min="0" step="0.01" value="300"></div></div>
          <div class="form-row"><label>Catch Basin Cost (each):</label><div class="input-group"><input id="catchBasinCost" type="number" min="0" step="0.01" value="2500"></div></div>
        </div>
      </div>

      <div style="margin-top:14px">
        <h3>Labor Inputs & Productivity</h3>
        <div class="form-row"><label>Plumber Hourly Rate:</label><div class="input-group"><input id="plumberRate" type="number" min="0" step="0.1" value="80"></div></div>
        <div class="form-row"><label>Helper Hourly Rate:</label><div class="input-group"><input id="helperRate" type="number" min="0" step="0.1" value="50"></div></div>

        <!-- New inputs: number of plumbers/helpers -->
        <div class="form-row"><label>Number of Plumbers:</label><div class="input-group"><input id="numPlumbers" type="number" min="1" step="1" value="2"></div></div>
        <div class="form-row"><label>Number of Helpers:</label><div class="input-group"><input id="numHelpers" type="number" min="0" step="1" value="2"></div></div>

        <div class="form-row"><label>Daily Work Hours:</label><div class="input-group"><input id="dailyHours" type="number" min="1" max="12" value="8"></div></div>

        <!-- Editable productivity rates (replace fixed constants) -->
        <div class="form-row"><label>Pipe laying productivity:</label><div class="input-group"><input id="productivityPipe" type="number" min="0.01" step="0.1" value="10"><div class="unit" id="productivityPipeUnit">m/day</div></div></div>
        <div class="form-row"><label>Manhole installation productivity:</label><div class="input-group"><input id="productivityManhole" type="number" min="0.01" step="0.1" value="0.8"><div class="unit" id="productivityManholeUnit">units/day</div></div></div>
        <div class="form-row"><label>Fitting installation productivity:</label><div class="input-group"><input id="productivityFitting" type="number" min="0.01" step="0.1" value="20"><div class="unit" id="productivityFittingUnit">pcs/day</div></div></div>

        <div class="form-row"><label>Waste Factor (%):</label><div class="input-group"><input id="wasteFactor" type="number" min="0" max="50" value="5"></div></div>
        <div class="form-row"><label>Overhead (%):</label><div class="input-group"><input id="overhead" type="number" min="0" max="50" value="15"></div></div>
        <div class="form-row"><label>Profit Margin (%):</label><div class="input-group"><input id="profitMargin" type="number" min="0" max="50" value="10"></div></div>
      </div>

      <div class="button-group"><button onclick="calculateCosts()">Calculate Total Costs</button></div>
      <div id="costsOutput" class="output"></div>
    </div>
  </div>

  <!-- Summary & Export -->
  <div id="summary" class="tab-content">
    <div class="section">
      <h2>Summary & Export</h2>
      <div class="button-group">
        <button onclick="generateSummary()">Generate Summary</button>
        <button class="secondary" onclick="exportToPDF()">Export to PDF</button>
        <button class="secondary" onclick="exportToExcel()">Export to Excel</button>
      </div>

      <div id="projectSummaryCard" class="summary-card"><h3>Project Summary</h3><div id="projectSummary"></div></div>
      <div id="sanitarySummaryCard" class="summary-card"><h3>Sanitary System Summary</h3><div id="sanitarySummary"></div></div>
      <div id="stormSummaryCard" class="summary-card"><h3>Storm Drain System Summary</h3><div id="stormSummary"></div></div>
      <div id="costBreakdownCard" class="summary-card"><h3>Cost Breakdown</h3>
        <table class="reference-table" id="costBreakdownTable">
          <thead><tr><th>Item</th><th>Quantity</th><th>Unit Cost</th><th>Total Cost</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="laborSummaryCard" class="summary-card"><h3>Labor Requirements</h3><div id="laborSummary"></div></div>
    </div>
  </div>

  <!-- Help & Formulas -->
  <div id="help" class="tab-content">
    <div class="section">
      <h2>Help & Formulas</h2>
      <div class="formula">Sanitary: Total Fixture Units = Σ(Fixture Count × Fixture Unit Value)</div>
      <div class="formula">Drainage Load (metric) L/s = Total Fixture Units × conversion factor (0.8 used)</div>
      <div class="formula">Storm (metric) Q (L/s) = C × I (mm/hr) × A (m²) / 360</div>
      <p>Internally the calculator computes in metric units and converts displayed values when needed. Use the Measurement Units selector to choose Metric or Imperial; productivity units and labels will update accordingly.</p>
      <h4>Fixture Unit Reference</h4>
      <table class="reference-table"><tr><th>Fixture</th><th>FU</th></tr><tr><td>Water Closet</td><td>6</td></tr><tr><td>Lavatory</td><td>1</td></tr><tr><td>Kitchen Sink</td><td>2</td></tr><tr><td>Shower</td><td>2</td></tr><tr><td>Bathtub</td><td>2</td></tr><tr><td>Urinal</td><td>4</td></tr><tr><td>Floor Drain</td><td>2</td></tr></table>
    </div>
  </div>

</div>

<script>
/* -----------------------
  Global state
-------------------------*/
let sanitaryResults = null;
let stormResults = null;
let costResults = null;

let laborResults = null;

/* Utility: formatting */
function formatNumber(num, dp=2){
  if (typeof num !== 'number' || isNaN(num)) return '';
  const rounded = Math.round((num+Number.EPSILON)*Math.pow(10,dp))/Math.pow(10,dp);
  return rounded.toLocaleString(undefined, {minimumFractionDigits: dp, maximumFractionDigits: dp});
}
function formatCurrency(n){
  if (typeof n !== 'number' || isNaN(n)) return '';
  const c = document.getElementById('currency').value;
  const symbol = c === 'PHP' ? '₱' : (c === 'USD' ? '$' : (c === 'EUR' ? '€' : '¥'));
  return symbol + ' ' + formatNumber(n,2);
}
function formatCurrencyForPDF(n){
  if (typeof n !== 'number' || isNaN(n)) return '';
  const c = document.getElementById('currency').value;
  const prefix = c === 'PHP' ? 'PHP ' : (c==='USD'? '$ ' : (c==='EUR' ? 'EUR ' : 'JPY '));
  return prefix + formatNumber(n,2);
}

/* -----------------------
  Unit conversion helpers (metric base)
-------------------------*/
const M_TO_FT = 3.28084;
const M2_TO_FT2 = 10.76391041671;
const LS_TO_GPM = 15.85032314;
const MM_TO_IN = 0.0393700787;
const IN_TO_MM = 25.4;

function setUnitLabels(){
  const units = document.getElementById('units').value;
  document.getElementById('sanLengthUnit').textContent = units==='metric' ? 'm' : 'ft';
  document.getElementById('stormLengthUnit').textContent = units==='metric' ? 'm' : 'ft';
  document.getElementById('roofAreaUnit').textContent = units==='metric' ? 'm²' : 'ft²';
  document.getElementById('pavementAreaUnit').textContent = units==='metric' ? 'm²' : 'ft²';
  document.getElementById('intensityUnit').textContent = units==='metric' ? 'mm/hr' : 'in/hr';
  document.getElementById('productivityPipeUnit').textContent = units==='metric' ? 'm/day' : 'ft/day';
  document.getElementById('productivityManholeUnit').textContent = 'units/day';
  document.getElementById('productivityFittingUnit').textContent = 'pcs/day';
  updateCommercialPipeLengthLabels(units==='metric'?'m':'ft');
}

function updateCommercialPipeLengthLabels(mode){
  const sanSelect = document.getElementById('sanPipeLength');
  const stormSelect = document.getElementById('stormPipeLength');
  Array.from([sanSelect, stormSelect]).forEach(sel=>{
    for(let i=0;i<sel.options.length;i++){
      const meters = parseFloat(sel.options[i].value);
      sel.options[i].text = mode==='m' ? meters + ' m' : (Math.round(meters*M_TO_FT*100)/100) + ' ft';
    }
  });
}

/* Convert visible numeric fields when units change */
function convertVisibleValuesToUnits(from, to){
  if(from === to) return;
  const san = document.getElementById('sanLength');
  const storm = document.getElementById('stormLength');
  const roof = document.getElementById('roofArea');
  const pave = document.getElementById('pavementArea');
  const intensity = document.getElementById('intensity');
  const prodPipe = document.getElementById('productivityPipe');

  if(from === 'metric' && to === 'imperial'){
    san.value = roundNum(parseFloat(san.value||0)*M_TO_FT,3);
    storm.value = roundNum(parseFloat(storm.value||0)*M_TO_FT,3);
    roof.value = roundNum(parseFloat(roof.value||0)*M2_TO_FT2,3);
    pave.value = roundNum(parseFloat(pave.value||0)*M2_TO_FT2,3);
    intensity.value = roundNum((parseFloat(intensity.value||0)*MM_TO_IN),3);
    prodPipe.value = roundNum(parseFloat(prodPipe.value||0)*M_TO_FT,3);
  } else if(from === 'imperial' && to === 'metric'){
    san.value = roundNum(parseFloat(san.value||0)/M_TO_FT,3);
    storm.value = roundNum(parseFloat(storm.value||0)/M_TO_FT,3);
    roof.value = roundNum(parseFloat(roof.value||0)/M2_TO_FT2,3);
    pave.value = roundNum(parseFloat(pave.value||0)/M2_TO_FT2,3);
    intensity.value = roundNum((parseFloat(intensity.value||0)*IN_TO_MM),3);
    prodPipe.value = roundNum(parseFloat(prodPipe.value||0)/M_TO_FT,3);
  }
  setUnitLabels();
}

function roundNum(v, dp=3){
  if(isNaN(v)) return '';
  return Math.round((v+Number.EPSILON)*Math.pow(10,dp))/Math.pow(10,dp);
}

/* -----------------------
  Tab handling
-------------------------*/
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', function(){
    const tab = this.getAttribute('data-tab');
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    this.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
  });
});

/* Initialize */
document.addEventListener('DOMContentLoaded', ()=>{
  addSanitaryPipe();
  addStormPipe();
  setUnitLabels();
  window._lastUnits = document.getElementById('units').value;
  document.getElementById('units').addEventListener('change', ()=>{
    const prev = window._lastUnits || 'metric';
    const next = document.getElementById('units').value;
    convertVisibleValuesToUnits(prev, next);
    window._lastUnits = next;
  });
});

/* Add pipe controls */
function addSanitaryPipe(){
  const c = document.getElementById('sanitaryPipesContainer');
  const div = document.createElement('div'); div.className='pipe-cost-row';
  div.innerHTML = `<select class="size-select">
    <option value="50">50 mm</option>
    <option value="75">75 mm</option>
    <option value="100" selected>100 mm</option>
    <option value="150">150 mm</option>
    <option value="200">200 mm</option>
  </select>
  <input class="cost-input" type="number" min="0" step="0.01" value="1500" />
  <button class="remove-pipe-btn" onclick="this.parentElement.remove()">Remove</button>`;
  c.appendChild(div);
}
function addStormPipe(){
  const c = document.getElementById('stormPipesContainer');
  const div = document.createElement('div'); div.className='pipe-cost-row';
  div.innerHTML = `<select class="size-select">
    <option value="75">75 mm</option>
    <option value="100" selected>100 mm</option>
    <option value="150">150 mm</option>
    <option value="200">200 mm</option>
    <option value="250">250 mm</option>
  </select>
  <input class="cost-input" type="number" min="0" step="0.01" value="1200" />
  <button class="remove-pipe-btn" onclick="this.parentElement.remove()">Remove</button>`;
  c.appendChild(div);
}

/* -----------------------
  Sanitary calculation
-------------------------*/
function calculateSanitary(){
  const wc = parseInt(document.getElementById('wc').value)||0;
  const lav = parseInt(document.getElementById('lav').value)||0;
  const sink = parseInt(document.getElementById('sink').value)||0;
  const shower = parseInt(document.getElementById('shower').value)||0;
  const tub = parseInt(document.getElementById('tub').value)||0;
  const urinal = parseInt(document.getElementById('urinal').value)||0;
  const floorDrain = parseInt(document.getElementById('floorDrain').value)||0;
  let sanLength = parseFloat(document.getElementById('sanLength').value)||0;
  const sanPipeLengthMeters = parseFloat(document.getElementById('sanPipeLength').value)||6;
  const sanSlope = parseFloat(document.getElementById('sanSlope').value)||2;
  const units = document.getElementById('units').value;

  if(units === 'imperial') sanLength = sanLength / M_TO_FT;

  const fixtureUnitsMap = { wc:6, lav:1, sink:2, shower:2, tub:2, urinal:4, floorDrain:2 };
  const totalFixtureUnits = wc*fixtureUnitsMap.wc + lav*fixtureUnitsMap.lav + sink*fixtureUnitsMap.sink + shower*fixtureUnitsMap.shower + tub*fixtureUnitsMap.tub + urinal*fixtureUnitsMap.urinal + floorDrain*fixtureUnitsMap.floorDrain;

  const drainageLoad_Ls = totalFixtureUnits * 0.8;

  let pipeSize;
  if(totalFixtureUnits <= 21) pipeSize = 50;
  else if(totalFixtureUnits <= 40) pipeSize = 75;
  else if(totalFixtureUnits <= 180) pipeSize = 100;
  else if(totalFixtureUnits <= 800) pipeSize = 150;
  else pipeSize = 200;

  const pipeQuantity = Math.ceil(sanLength / sanPipeLengthMeters);
  const traps = wc + lav + sink + shower + tub + urinal + floorDrain;
  const vents = wc + lav + sink + shower + tub + urinal;
  const cleanouts = Math.ceil(sanLength / 30);
  const sanManholes = Math.ceil(sanLength / 50);
  const sanFittings = Math.ceil(sanLength / 10);

  sanitaryResults = {
    totalFixtureUnits,
    drainageLoad_Ls,
    pipeSize,
    pipeQuantity,
    pipeLength_m: sanLength,
    traps,
    vents,
    cleanouts,
    manholes: sanManholes,
    fittings: sanFittings
  };

  const out = document.getElementById('sanitaryOutput');
  const flowDisplay = units==='metric' ? formatNumber(sanitaryResults.drainageLoad_Ls,2) + ' L/s' : formatNumber(sanitaryResults.drainageLoad_Ls * LS_TO_GPM,2) + ' gpm';
  const pipeLengthDisplay = units==='metric' ? formatNumber(sanitaryResults.pipeLength_m,1) + ' m' : formatNumber(sanitaryResults.pipeLength_m * M_TO_FT,1) + ' ft';
  out.innerHTML = `<h3>Sanitary System Results</h3>
    <p><strong>Total Fixture Units:</strong> ${formatNumber(sanitaryResults.totalFixtureUnits,0)}</p>
    <p><strong>Drainage Load:</strong> ${flowDisplay}</p>
    <p><strong>Recommended Pipe Size:</strong> ${sanitaryResults.pipeSize} mm</p>
    <p><strong>Pipe Quantity:</strong> ${sanitaryResults.pipeQuantity} pcs</p>
    <p><strong>Pipe Length:</strong> ${pipeLengthDisplay}</p>
    <p><strong>Accessories:</strong></p>
    <ul>
      <li>Traps: ${sanitaryResults.traps}</li>
      <li>Vents: ${sanitaryResults.vents}</li>
      <li>Cleanouts: ${sanitaryResults.cleanouts}</li>
      <li>Manholes: ${sanitaryResults.manholes}</li>
      <li>Fittings/Elbows: ${sanitaryResults.fittings}</li>
    </ul>`;
  out.style.display = 'block';
  return sanitaryResults;
}

/* -----------------------
  Storm calculation
-------------------------*/
function calculateStorm(){
  const units = document.getElementById('units').value;
  let roofArea = parseFloat(document.getElementById('roofArea').value)||0;
  let pavementArea = parseFloat(document.getElementById('pavementArea').value)||0;
  let intensity = parseFloat(document.getElementById('intensity').value)||0;
  const coef = parseFloat(document.getElementById('coef').value)||0.9;
  let stormLength = parseFloat(document.getElementById('stormLength').value)||0;
  const stormPipeLengthMeters = parseFloat(document.getElementById('stormPipeLength').value)||6;

  if(units === 'imperial'){
    roofArea = roofArea * 0.092903;
    pavementArea = pavementArea * 0.092903;
    intensity = intensity * IN_TO_MM;
    stormLength = stormLength / M_TO_FT;
  }

  const totalArea_m2 = roofArea + pavementArea;
  const runoff_Ls = coef * intensity * totalArea_m2 / 360;

  let pipeSize;
  if (runoff_Ls <= 1.2) pipeSize = 75;
  else if (runoff_Ls <= 2.5) pipeSize = 100;
  else if (runoff_Ls <= 5.3) pipeSize = 150;
  else if (runoff_Ls <= 15.0) pipeSize = 200;
  else pipeSize = 250;

  const pipeQuantity = Math.ceil(stormLength / stormPipeLengthMeters);
  const downspouts = Math.ceil((roofArea) / 100);
  const catchBasins = Math.ceil(stormLength / 60);
  const stormManholes = Math.ceil(stormLength / 50);
  const stormFittings = Math.ceil(stormLength / 10);

  stormResults = {
    totalArea_m2,
    runoff_Ls,
    pipeSize,
    pipeQuantity,
    pipeLength_m: stormLength,
    downspouts,
    catchBasins,
    manholes: stormManholes,
    fittings: stormFittings,
    coef,
    intensity_mm_per_hr: intensity
  };

  const out = document.getElementById('stormOutput');
  const areaDisplay = units === 'metric' ? formatNumber(stormResults.totalArea_m2,2) + ' m²' : formatNumber(stormResults.totalArea_m2 * M2_TO_FT2,2) + ' ft²';
  const intensityDisplay = units === 'metric' ? formatNumber(stormResults.intensity_mm_per_hr,1) + ' mm/hr' : formatNumber(stormResults.intensity_mm_per_hr * MM_TO_IN,2) + ' in/hr';
  const runoffDisplay = units === 'metric' ? formatNumber(stormResults.runoff_Ls,2) + ' L/s' : formatNumber(stormResults.runoff_Ls * LS_TO_GPM,2) + ' gpm';
  const pipeLengthDisplay = units === 'metric' ? formatNumber(stormResults.pipeLength_m,1) + ' m' : formatNumber(stormResults.pipeLength_m * M_TO_FT,1) + ' ft';

  out.innerHTML = `<h3>Storm Drain System Results</h3>
    <p><strong>Total Area:</strong> ${areaDisplay}</p>
    <p><strong>Runoff Coefficient:</strong> ${formatNumber(stormResults.coef,2)}</p>
    <p><strong>Rainfall Intensity:</strong> ${intensityDisplay}</p>
    <p><strong>Runoff:</strong> ${runoffDisplay}</p>
    <p><strong>Recommended Pipe Size:</strong> ${stormResults.pipeSize} mm</p>
    <p><strong>Pipe Quantity:</strong> ${stormResults.pipeQuantity} pcs</p>
    <p><strong>Pipe Length:</strong> ${pipeLengthDisplay}</p>
    <p><strong>Accessories:</strong></p>
    <ul>
      <li>Downspouts: ${stormResults.downspouts}</li>
      <li>Catch Basins: ${stormResults.catchBasins}</li>
      <li>Manholes: ${stormResults.manholes}</li>
      <li>Fittings/Elbows: ${stormResults.fittings}</li>
    </ul>`;
  out.style.display = 'block';
  return stormResults;
}

/* -----------------------
  Costs & Labor calculation
-------------------------*/
function calculateCosts(){
  if(!sanitaryResults){ alert('Please calculate Sanitary System first.'); return; }
  if(!stormResults){ alert('Please calculate Storm Drain System first.'); return; }

  const plumberRate = parseFloat(document.getElementById('plumberRate').value)||0;
  const helperRate = parseFloat(document.getElementById('helperRate').value)||0;
  const dailyHours = parseFloat(document.getElementById('dailyHours').value)||8;
  const wasteFactor = parseFloat(document.getElementById('wasteFactor').value)||0;
  const overhead = parseFloat(document.getElementById('overhead').value)||0;
  const profitMargin = parseFloat(document.getElementById('profitMargin').value)||0;

  const trapCost = parseFloat(document.getElementById('trapCost').value)||0;
  const ventCost = parseFloat(document.getElementById('ventCost').value)||0;
  const cleanoutCost = parseFloat(document.getElementById('cleanoutCost').value)||0;
  const manholeCost = parseFloat(document.getElementById('manholeCost').value)||0;
  const fittingCost = parseFloat(document.getElementById('fittingCost').value)||0;
  const downspoutCost = parseFloat(document.getElementById('downspoutCost').value)||0;
  const catchBasinCost = parseFloat(document.getElementById('catchBasinCost').value)||0;

  // pipe costs
  let sanitaryPipeCost = 0;
  const sanitaryPipes = Array.from(document.getElementById('sanitaryPipesContainer').getElementsByClassName('pipe-cost-row')||[]);
  for(const p of sanitaryPipes){
    const sizeVal = parseFloat(p.querySelector('.size-select').value);
    const costVal = parseFloat(p.querySelector('.cost-input').value)||0;
    if(sizeVal === sanitaryResults.pipeSize){
      sanitaryPipeCost = costVal * sanitaryResults.pipeQuantity;
      break;
    }
  }
  if(sanitaryPipeCost === 0 && sanitaryPipes.length>0){
    sanitaryPipeCost = (parseFloat(sanitaryPipes[0].querySelector('.cost-input').value)||0) * sanitaryResults.pipeQuantity;
  }

  let stormPipeCost = 0;
  const stormPipes = Array.from(document.getElementById('stormPipesContainer').getElementsByClassName('pipe-cost-row')||[]);
  for(const p of stormPipes){
    const sizeVal = parseFloat(p.querySelector('.size-select').value);
    const costVal = parseFloat(p.querySelector('.cost-input').value)||0;
    if(sizeVal === stormResults.pipeSize){
      stormPipeCost = costVal * stormResults.pipeQuantity;
      break;
    }
  }
  if(stormPipeCost === 0 && stormPipes.length>0){
    stormPipeCost = (parseFloat(stormPipes[0].querySelector('.cost-input').value)||0) * stormResults.pipeQuantity;
  }

  const sanitaryMaterialCost = sanitaryPipeCost + (sanitaryResults.traps * trapCost) + (sanitaryResults.vents * ventCost) + (sanitaryResults.cleanouts * cleanoutCost) + (sanitaryResults.manholes * manholeCost) + (sanitaryResults.fittings * fittingCost);
  const stormMaterialCost = stormPipeCost + (stormResults.downspouts * downspoutCost) + (stormResults.catchBasins * catchBasinCost) + (stormResults.manholes * manholeCost) + (stormResults.fittings * fittingCost);
  const totalMaterialCost = sanitaryMaterialCost + stormMaterialCost;

  // PRODUCTIVITY
  const units = document.getElementById('units').value;
  let productivityPipe = parseFloat(document.getElementById('productivityPipe').value) || 1;
  let productivityManhole = parseFloat(document.getElementById('productivityManhole').value) || 0.8;
  let productivityFitting = parseFloat(document.getElementById('productivityFitting').value) || 20;

  if(units === 'imperial') productivityPipe = productivityPipe / M_TO_FT;

  const totalPipeLength_m = sanitaryResults.pipeLength_m + stormResults.pipeLength_m;
  const totalManholes = sanitaryResults.manholes + stormResults.manholes;
  const totalFittings = sanitaryResults.fittings + stormResults.fittings;

  const pipeLayingDays = productivityPipe > 0 ? totalPipeLength_m / productivityPipe : 0;
  const manholeDays = productivityManhole > 0 ? totalManholes / productivityManhole : 0;
  const fittingDays = productivityFitting > 0 ? totalFittings / productivityFitting : 0;

  const totalLaborDays = pipeLayingDays + manholeDays + fittingDays;
  const totalLaborHours = totalLaborDays * dailyHours;

  const numPlumbers = parseInt(document.getElementById('numPlumbers').value)||1;
  const numHelpers = parseInt(document.getElementById('numHelpers').value)||0;
  const totalWorkers = Math.max(1, numPlumbers + numHelpers);

  const plumberHours = totalLaborHours * (numPlumbers / totalWorkers);
  const helperHours = totalLaborHours * (numHelpers / totalWorkers);
  const plumberCost = plumberHours * plumberRate;
  const helperCost = helperHours * helperRate;
  const totalLaborCost = plumberCost + helperCost;

  const costWithWaste = totalMaterialCost * (1 + wasteFactor/100);
  const costWithOverhead = (costWithWaste + totalLaborCost) * (1 + overhead/100);
  const totalCost = costWithOverhead * (1 + profitMargin/100);

  costResults = {
    sanitaryMaterialCost, stormMaterialCost, totalMaterialCost,
    sanitaryPipeCost, stormPipeCost,
    sanitaryTrapsCost: sanitaryResults.traps * (trapCost||0),
    sanitaryVentsCost: sanitaryResults.vents * (ventCost||0),
    sanitaryCleanoutsCost: sanitaryResults.cleanouts * (cleanoutCost||0),
    sanitaryManholesCost: sanitaryResults.manholes * (manholeCost||0),
    sanitaryFittingsCost: sanitaryResults.fittings * (fittingCost||0),
    stormDownspoutsCost: stormResults.downspouts * (downspoutCost||0),
    stormCatchBasinsCost: stormResults.catchBasins * (catchBasinCost||0),
    stormManholesCost: stormResults.manholes * (manholeCost||0),
    stormFittingsCost: stormResults.fittings * (fittingCost||0),
    totalMaterialCost, totalLaborCost, totalCost,
    pipeLayingDays, manholeDays, fittingDays,
    totalPipeLength_m, totalManholes, totalFittings
  };

  laborResults = {
    totalLaborHours, plumberHours, helperHours, totalLaborDays, plumberCost, helperCost, totalLaborCost, numPlumbers, numHelpers
  };

  const out = document.getElementById('costsOutput');
  out.innerHTML = `<h3>Cost & Labor Results</h3>
    <p><strong>Total Material Cost:</strong> ${formatCurrency(totalMaterialCost)}</p>
    <p><strong>Total Labor Cost:</strong> ${formatCurrency(totalLaborCost)}</p>
    <p><strong>Total Cost (with waste, overhead & profit):</strong> ${formatCurrency(totalCost)}</p>
    <p><strong>Labor Requirements:</strong></p>
    <ul>
      <li>Total Labor Hours: ${formatNumber(totalLaborHours,1)} hours</li>
      <li>Plumber Hours: ${formatNumber(plumberHours,1)} hours (${laborResults.numPlumbers} plumbers)</li>
      <li>Helper Hours: ${formatNumber(helperHours,1)} hours (${laborResults.numHelpers} helpers)</li>
      <li>Equivalent Man-Days (single worker): ${formatNumber(totalLaborDays,2)} days</li>
      <li>Estimated pipe laying days (1 worker): ${formatNumber(pipeLayingDays,2)} days</li>
      <li>Estimated manhole days (1 worker): ${formatNumber(manholeDays,2)} days</li>
      <li>Estimated fitting days (1 worker): ${formatNumber(fittingDays,2)} days</li>
    </ul>`;
  out.style.display = 'block';
  return { costResults, laborResults };
}

/* -----------------------
  Summary generation
-------------------------*/
function generateSummary(){
  if(!sanitaryResults){ alert('Please calculate Sanitary System first.'); return; }
  if(!stormResults){ alert('Please calculate Storm Drain System first.'); return; }
  if(!costResults || !laborResults){ alert('Please calculate Costs & Labor first.'); return; }

  document.getElementById('projectSummaryCard').style.display = 'block';
  document.getElementById('sanitarySummaryCard').style.display = 'block';
  document.getElementById('stormSummaryCard').style.display = 'block';
  document.getElementById('costBreakdownCard').style.display = 'block';
  document.getElementById('laborSummaryCard').style.display = 'block';

  document.getElementById('projectSummary').innerHTML = `<p><strong>Project Name:</strong> ${document.getElementById('projectName').value}</p>
    <p><strong>Client:</strong> ${document.getElementById('clientName').value}</p>
    <p><strong>Location:</strong> ${document.getElementById('projectLocation').value}</p>
    <p><strong>Prepared By:</strong> ${document.getElementById('preparedBy').value}</p>
    <p><strong>Currency:</strong> ${document.getElementById('currency').value}</p>
    <p><strong>Units:</strong> ${document.getElementById('units').value}</p>`;

  document.getElementById('sanitarySummary').innerHTML = `<p><strong>Total Fixture Units:</strong> ${formatNumber(sanitaryResults.totalFixtureUnits,0)}</p>
    <p><strong>Drainage Load:</strong> ${document.getElementById('units').value==='metric'?formatNumber(sanitaryResults.drainageLoad_Ls,2)+' L/s':formatNumber(sanitaryResults.drainageLoad_Ls*LS_TO_GPM,2)+' gpm'}</p>
    <p><strong>Pipe Size:</strong> ${sanitaryResults.pipeSize} mm</p>
    <p><strong>Pipe Quantity:</strong> ${sanitaryResults.pipeQuantity} pcs</p>
    <p><strong>Pipe Length:</strong> ${document.getElementById('units').value==='metric'?formatNumber(sanitaryResults.pipeLength_m,1)+' m':formatNumber(sanitaryResults.pipeLength_m*M_TO_FT,1)+' ft'}</p>`;

  document.getElementById('stormSummary').innerHTML = `<p><strong>Total Area:</strong> ${document.getElementById('units').value==='metric'?formatNumber(stormResults.totalArea_m2,2)+' m²':formatNumber(stormResults.totalArea_m2*M2_TO_FT2,2)+' ft²'}</p>
    <p><strong>Runoff:</strong> ${document.getElementById('units').value==='metric'?formatNumber(stormResults.runoff_Ls,2)+' L/s':formatNumber(stormResults.runoff_Ls*LS_TO_GPM,2)+' gpm'}</p>
    <p><strong>Pipe Size:</strong> ${stormResults.pipeSize} mm</p>
    <p><strong>Pipe Quantity:</strong> ${stormResults.pipeQuantity} pcs</p>
    <p><strong>Pipe Length:</strong> ${document.getElementById('units').value==='metric'?formatNumber(stormResults.pipeLength_m,1)+' m':formatNumber(stormResults.pipeLength_m*M_TO_FT,1)+' ft'}</p>`;

  const tbody = document.querySelector('#costBreakdownTable tbody');
  tbody.innerHTML = '';
  function addRow(item, qty, unit, unitCostDisplay, totalCost){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${item}</td><td>${qty?qty:''} ${unit||''}</td><td>${unitCostDisplay||''}</td><td>${totalCost?formatCurrency(totalCost):''}</td>`;
    tbody.appendChild(tr);
  }

  addRow('Sanitary Pipes', sanitaryResults.pipeQuantity, 'pcs', sanitaryResults.pipeQuantity>0?formatCurrency(costResults.sanitaryPipeCost/sanitaryResults.pipeQuantity):'', costResults.sanitaryPipeCost);
  addRow('Sanitary Traps', sanitaryResults.traps, 'pcs', formatCurrency(parseFloat(document.getElementById('trapCost').value||0)), costResults.sanitaryTrapsCost);
  addRow('Sanitary Vents', sanitaryResults.vents, 'pcs', formatCurrency(parseFloat(document.getElementById('ventCost').value||0)), costResults.sanitaryVentsCost);
  addRow('Sanitary Cleanouts', sanitaryResults.cleanouts, 'pcs', formatCurrency(parseFloat(document.getElementById('cleanoutCost').value||0)), costResults.sanitaryCleanoutsCost);
  addRow('Sanitary Manholes', sanitaryResults.manholes, 'pcs', formatCurrency(parseFloat(document.getElementById('manholeCost').value||0)), costResults.sanitaryManholesCost);
  addRow('Sanitary Fittings', sanitaryResults.fittings, 'pcs', formatCurrency(parseFloat(document.getElementById('fittingCost').value||0)), costResults.sanitaryFittingsCost);

  addRow('Storm Pipes', stormResults.pipeQuantity, 'pcs', stormResults.pipeQuantity>0?formatCurrency(costResults.stormPipeCost/stormResults.pipeQuantity):'', costResults.stormPipeCost);
  addRow('Downspouts', stormResults.downspouts, 'pcs', formatCurrency(parseFloat(document.getElementById('downspoutCost').value||0)), costResults.stormDownspoutsCost);
  addRow('Catch Basins', stormResults.catchBasins, 'pcs', formatCurrency(parseFloat(document.getElementById('catchBasinCost').value||0)), costResults.stormCatchBasinsCost);
  addRow('Storm Manholes', stormResults.manholes, 'pcs', formatCurrency(parseFloat(document.getElementById('manholeCost').value||0)), costResults.stormManholesCost);
  addRow('Storm Fittings', stormResults.fittings, 'pcs', formatCurrency(parseFloat(document.getElementById('fittingCost').value||0)), costResults.stormFittingsCost);

  addRow('Subtotal - Materials', '', '', '', costResults.totalMaterialCost);
  addRow('Labor Cost', '', '', '', costResults.totalLaborCost);
  addRow('Waste Factor', '', '', document.getElementById('wasteFactor').value + '%', costResults.totalMaterialCost*(parseFloat(document.getElementById('wasteFactor').value||0)/100));
  addRow('Overhead', '', '', document.getElementById('overhead').value + '%', ((costResults.totalMaterialCost*(1 + (parseFloat(document.getElementById('wasteFactor').value||0)/100))) + costResults.totalLaborCost)*(parseFloat(document.getElementById('overhead').value||0)/100));
  addRow('Profit Margin', '', '', document.getElementById('profitMargin').value + '%', costResults.totalCost - (((costResults.totalMaterialCost*(1 + (parseFloat(document.getElementById('wasteFactor').value||0)/100))) + costResults.totalLaborCost)*(1 + (parseFloat(document.getElementById('overhead').value||0)/100))));
  addRow('TOTAL PROJECT COST', '', '', '', costResults.totalCost);

  document.getElementById('laborSummary').innerHTML = `<p><strong>Total Labor Hours:</strong> ${formatNumber(laborResults.totalLaborHours||0,1)} hours</p>
    <p><strong>Plumber Hours:</strong> ${formatNumber(laborResults.plumberHours||0,1)} hours (${laborResults.numPlumbers} plumbers)</p>
    <p><strong>Helper Hours:</strong> ${formatNumber(laborResults.helperHours||0,1)} hours (${laborResults.numHelpers} helpers)</p>
    <p><strong>Equivalent Man-Days (single worker):</strong> ${formatNumber(laborResults.totalLaborDays||0,1)} days</p>
    <p><strong>Total Labor Cost:</strong> ${formatCurrency(laborResults.totalLaborCost||0)}</p>

    <p><strong>Productivity Rates used:</strong></p>
    <ul>
      <li>Pipe laying: ${document.getElementById('productivityPipe').value} ${document.getElementById('productivityPipeUnit').textContent}</li>
      <li>Manhole installation: ${document.getElementById('productivityManhole').value} ${document.getElementById('productivityManholeUnit').textContent}</li>
      <li>Fitting installation: ${document.getElementById('productivityFitting').value} ${document.getElementById('productivityFittingUnit').textContent}</li>
    </ul>`;
}

/* -----------------------
  PDF export styled like sample image
  (UPDATED to match your requests)
-------------------------*/
function extractBOQDataForPDF(){
  if(!costResults || !laborResults) return [];
  const wasteFactor = parseFloat(document.getElementById('wasteFactor').value||0);
  const overhead = parseFloat(document.getElementById('overhead').value||0);
  const profit = parseFloat(document.getElementById('profitMargin').value||0);
  const subtotalMaterials = costResults.totalMaterialCost;
  const wasteAmount = subtotalMaterials * (wasteFactor/100);
  const materialsWithWaste = subtotalMaterials + wasteAmount;
  const subtotal = materialsWithWaste + costResults.totalLaborCost;
  const overheadAmount = subtotal * (overhead/100);
  const profitAmount = (subtotal + overheadAmount) * (profit/100);
  const totalProjectCost = subtotal + overheadAmount + profitAmount;

  const boq = [
    ["Description","Quantity","Unit","Unit Rate","Amount"],
    ["Materials","","","",""],
    ["Sanitary Pipes", sanitaryResults.pipeQuantity.toString(), "pcs", sanitaryResults.pipeQuantity>0 ? formatCurrencyForPDF(costResults.sanitaryPipeCost/sanitaryResults.pipeQuantity) : formatCurrencyForPDF(0), formatCurrencyForPDF(costResults.sanitaryPipeCost)],
    ["Sanitary Traps", sanitaryResults.traps.toString(), "pcs", formatCurrencyForPDF(parseFloat(document.getElementById('trapCost').value||0)), formatCurrencyForPDF(costResults.sanitaryTrapsCost)],
    ["Sanitary Vents", sanitaryResults.vents.toString(), "pcs", formatCurrencyForPDF(parseFloat(document.getElementById('ventCost').value||0)), formatCurrencyForPDF(costResults.sanitaryVentsCost)],
    ["Sanitary Cleanouts", sanitaryResults.cleanouts.toString(), "pcs", formatCurrencyForPDF(parseFloat(document.getElementById('cleanoutCost').value||0)), formatCurrencyForPDF(costResults.sanitaryCleanoutsCost)],
    ["Sanitary Manholes", sanitaryResults.manholes.toString(), "pcs", formatCurrencyForPDF(parseFloat(document.getElementById('manholeCost').value||0)), formatCurrencyForPDF(costResults.sanitaryManholesCost)],
    ["Sanitary Fittings", sanitaryResults.fittings.toString(), "pcs", formatCurrencyForPDF(parseFloat(document.getElementById('fittingCost').value||0)), formatCurrencyForPDF(costResults.sanitaryFittingsCost)],
    ["Storm Pipes", stormResults.pipeQuantity.toString(), "pcs", stormResults.pipeQuantity>0 ? formatCurrencyForPDF(costResults.stormPipeCost/stormResults.pipeQuantity) : formatCurrencyForPDF(0), formatCurrencyForPDF(costResults.stormPipeCost)],
    ["Downspouts", stormResults.downspouts.toString(), "pcs", formatCurrencyForPDF(parseFloat(document.getElementById('downspoutCost').value||0)), formatCurrencyForPDF(costResults.stormDownspoutsCost)],
    ["Catch Basins", stormResults.catchBasins.toString(), "pcs", formatCurrencyForPDF(parseFloat(document.getElementById('catchBasinCost').value||0)), formatCurrencyForPDF(costResults.stormCatchBasinsCost)],
    ["Storm Manholes", stormResults.manholes.toString(), "pcs", formatCurrencyForPDF(parseFloat(document.getElementById('manholeCost').value||0)), formatCurrencyForPDF(costResults.stormManholesCost)],
    ["Storm Fittings", stormResults.fittings.toString(), "pcs", formatCurrencyForPDF(parseFloat(document.getElementById('fittingCost').value||0)), formatCurrencyForPDF(costResults.stormFittingsCost)],
    ["Materials Subtotal", "", "", "", formatCurrencyForPDF(subtotalMaterials)],
    ["Waste (" + wasteFactor + "%)", "", "", "", formatCurrencyForPDF(wasteAmount)],
    ["Materials Total", "", "", "", formatCurrencyForPDF(materialsWithWaste)],
    ["Labor", "", "", "", ""],
    ["Plumber", formatNumber(laborResults.plumberHours,1), "hours", formatCurrencyForPDF(parseFloat(document.getElementById('plumberRate').value||0)), formatCurrencyForPDF(laborResults.plumberCost)],
    ["Helper", formatNumber(laborResults.helperHours,1), "hours", formatCurrencyForPDF(parseFloat(document.getElementById('helperRate').value||0)), formatCurrencyForPDF(laborResults.helperCost)],
    ["Labor Total", "", "", "", formatCurrencyForPDF(costResults.totalLaborCost)],
    ["Summary", "", "", "", ""],
    ["Materials + Labor", "", "", "", formatCurrencyForPDF(subtotal)],
    ["Overhead (" + overhead + "%)", "", "", "", formatCurrencyForPDF(overheadAmount)],
    ["Profit Margin (" + profit + "%)", "", "", "", formatCurrencyForPDF(profitAmount)],
    ["TOTAL PROJECT COST", "", "", "", formatCurrencyForPDF(totalProjectCost)]
  ];
  // Note: productivity rows removed here per your request
  return boq;
}

function exportToPDF(){
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' }); // use points for more precise layout
    doc.setFont('helvetica');

    const leftMargin = 40;
    let y = 40;
    doc.setFontSize(16);
    doc.setFont(undefined,'bold');
    doc.text("Sanitary & Storm Drain Report", leftMargin, y);
    doc.setFontSize(10);
    doc.setFont(undefined,'normal');
    y += 18;

    // Project info top-left / right
    const projectName = document.getElementById('projectName').value || '';
    const clientName = document.getElementById('clientName').value || '';
    const projectLocation = document.getElementById('projectLocation').value || '';
    const preparedBy = document.getElementById('preparedBy').value || '';
    const dateStr = new Date().toLocaleDateString();

    doc.text(`Project: ${projectName}`, leftMargin, y);
    doc.text(`Client: ${clientName}`, 380, y);
    y += 14;
    doc.text(`Location: ${projectLocation}`, leftMargin, y);
    doc.text(`Date: ${dateStr}`, 380, y);
    y += 14;
    doc.text(`Prepared by: ${preparedBy}`, leftMargin, y);
    y += 16;

    // (Removed: Sanitary Pipe Length & Storm Pipe Length lines per your request)

    // Bill of Quantities Title
    doc.setFontSize(12);
    doc.setFont(undefined,'bold');
    doc.text("Bill of Quantities", leftMargin, y);
    doc.setFont(undefined,'normal');
    y += 8;

    // Prepare table data
    const boq = extractBOQDataForPDF();
    const header = [["Description","Quantity","Unit","Unit Rate","Amount"]];
    doc.autoTable({
      startY: y,
      head: header,
      body: boq.slice(1),
      theme: 'grid',
      styles: { font: 'helvetica', fontSize:10, cellPadding:6, overflow:'linebreak' },
      headStyles: { fillColor: [230,230,230], textColor: 0, halign:'center', fontStyle:'bold' },
      columnStyles: {
        0: { cellWidth: 200, halign:'left' },
        1: { cellWidth: 60, halign:'center' },
        2: { cellWidth: 60, halign:'center' },
        3: { cellWidth: 100, halign:'right' },
        4: { cellWidth: 100, halign:'right' }
      },
      didParseCell: function(data){
        const txt = (data.cell.raw||'').toString();
        // Group titles as merged rows
        if(txt === 'Materials' || txt === 'Labor' || txt === 'Summary'){
          data.cell.colSpan = 5;
          data.cell.styles.halign = 'left';
          data.cell.styles.fontStyle = 'bold';
          data.cell.styles.fillColor = [240,240,240];
        }
        if(txt.includes("TOTAL PROJECT COST")){
          data.cell.styles.fontStyle = 'bold';
          data.cell.styles.fillColor = [200,200,200];
        }
      },
      didDrawPage: function(data){
        // page footer
        const pageSize = doc.internal.pageSize;
        doc.setFontSize(9);
        doc.setTextColor(120);
        doc.text(`Page ${data.pageNumber}`, pageSize.width - 60, pageSize.height - 30);
      }
    });

    // After table, add the summaries (Sanitary System Summary, Storm Drain Summary, Labor Requirements)
    let posY = doc.autoTable.previous.finalY + 20;
    doc.setFontSize(12);
    doc.setFont(undefined,'bold');
    doc.text('Sanitary System Summary', leftMargin, posY);
    doc.setFont(undefined,'normal');
    posY += 14;
    doc.text(`Total Fixture Units: ${sanitaryResults.totalFixtureUnits}`, leftMargin, posY);
    posY += 12;
    // show in L/s (metric) by default; user units could be added if desired
    const sanFlowDisplay = document.getElementById('units').value==='metric' ? `${formatNumber(sanitaryResults.drainageLoad_Ls,2)} L/s` : `${formatNumber(sanitaryResults.drainageLoad_Ls*LS_TO_GPM,2)} gpm`;
    doc.text(`Drainage Load: ${sanFlowDisplay}`, leftMargin, posY);
    posY += 12;
    doc.text(`Pipe Size: ${sanitaryResults.pipeSize} mm`, leftMargin, posY);
    posY += 12;
    doc.text(`Pipe Quantity: ${sanitaryResults.pipeQuantity} pcs`, leftMargin, posY);
    posY += 12;
    const sanLenDisplay = document.getElementById('units').value==='metric' ? `${formatNumber(sanitaryResults.pipeLength_m,1)} m` : `${formatNumber(sanitaryResults.pipeLength_m*M_TO_FT,1)} ft`;
    doc.text(`Pipe Length: ${sanLenDisplay}`, leftMargin, posY);
    posY += 20;

    doc.setFont(undefined,'bold');
    doc.text('Storm Drain Summary', leftMargin, posY);
    doc.setFont(undefined,'normal');
    posY += 14;
    const stormAreaDisplay = document.getElementById('units').value==='metric' ? `${formatNumber(stormResults.totalArea_m2,2)} m²` : `${formatNumber(stormResults.totalArea_m2*M2_TO_FT2,2)} ft²`;
    doc.text(`Total Area: ${stormAreaDisplay}`, leftMargin, posY);
    posY += 12;
    const stormRunoffDisplay = document.getElementById('units').value==='metric' ? `${formatNumber(stormResults.runoff_Ls,2)} L/s` : `${formatNumber(stormResults.runoff_Ls*LS_TO_GPM,2)} gpm`;
    doc.text(`Runoff: ${stormRunoffDisplay}`, leftMargin, posY);
    posY += 12;
    doc.text(`Pipe Size: ${stormResults.pipeSize} mm`, leftMargin, posY);
    posY += 12;
    doc.text(`Pipe Quantity: ${stormResults.pipeQuantity} pcs`, leftMargin, posY);
    posY += 12;
    const stormLenDisplay = document.getElementById('units').value==='metric' ? `${formatNumber(stormResults.pipeLength_m,1)} m` : `${formatNumber(stormResults.pipeLength_m*M_TO_FT,1)} ft`;
    doc.text(`Pipe Length: ${stormLenDisplay}`, leftMargin, posY);
    posY += 20;

    doc.setFont(undefined,'bold');
    doc.text('Labor Requirements', leftMargin, posY);
    doc.setFont(undefined,'normal');
    posY += 14;
    doc.text(`Total Labor Hours: ${formatNumber(laborResults.totalLaborHours,1)} hrs`, leftMargin, posY);
    posY += 12;
    doc.text(`Plumber Hours: ${formatNumber(laborResults.plumberHours,1)} hrs`, leftMargin, posY);
    posY += 12;
    doc.text(`Helper Hours: ${formatNumber(laborResults.helperHours,1)} hrs`, leftMargin, posY);
    posY += 12;
    doc.text(`Equivalent Man-Days (single worker): ${formatNumber(laborResults.totalLaborDays,2)} days`, leftMargin, posY);
    posY += 12;
    doc.text(`Total Labor Cost: ${formatCurrencyForPDF(laborResults.totalLaborCost)}`, leftMargin, posY);
    posY += 12;
    const prodLine = `Pipe laying: ${document.getElementById('productivityPipe').value} ${document.getElementById('productivityPipeUnit').textContent}; Manhole: ${document.getElementById('productivityManhole').value} ${document.getElementById('productivityManholeUnit').textContent}; Fitting: ${document.getElementById('productivityFitting').value} ${document.getElementById('productivityFittingUnit').textContent}`;
    doc.text(`Productivity rates used: ${prodLine}`, leftMargin, posY, {maxWidth: 500, align: 'left'});

    // Save file
    const safeName = (document.getElementById('projectName').value||'project').replace(/[^a-z0-9]/gi,'_');
    doc.save(`${safeName}_Report.pdf`);
  }catch(err){
    console.error(err);
    alert('Error generating PDF: ' + err.message);
  }
}

/* -----------------------
  Excel export
-------------------------*/
function exportToExcel(){
  if(!sanitaryResults || !stormResults || !costResults){ alert('Please run calculations first'); return; }
  const wb = XLSX.utils.book_new();
  const wsData = [
    ['Sanitary & Storm Drain Report'],
    [],
    ['Project Information'],
    ['Project Name', document.getElementById('projectName').value],
    ['Client', document.getElementById('clientName').value],
    ['Location', document.getElementById('projectLocation').value],
    ['Prepared By', document.getElementById('preparedBy').value],
    ['Currency', document.getElementById('currency').value],
    ['Date', new Date().toLocaleDateString()],
    [],
    ['Sanitary System'],
    ['Total Fixture Units', sanitaryResults.totalFixtureUnits],
    ['Drainage Load', (document.getElementById('units').value==='metric' ? sanitaryResults.drainageLoad_Ls + ' L/s' : (sanitaryResults.drainageLoad_Ls*LS_TO_GPM).toFixed(2) + ' gpm')],
    ['Pipe Size', sanitaryResults.pipeSize + ' mm'],
    ['Pipe Quantity', sanitaryResults.pipeQuantity],
    ['Pipe Length', document.getElementById('units').value==='metric' ? sanitaryResults.pipeLength_m + ' m' : (sanitaryResults.pipeLength_m*M_TO_FT).toFixed(2) + ' ft'],
    [],
    ['Storm System'],
    ['Total Area', document.getElementById('units').value==='metric' ? stormResults.totalArea_m2 + ' m²' : (stormResults.totalArea_m2*M2_TO_FT2).toFixed(2) + ' ft²'],
    ['Runoff', document.getElementById('units').value==='metric' ? stormResults.runoff_Ls + ' L/s' : (stormResults.runoff_Ls*LS_TO_GPM).toFixed(2) + ' gpm'],
    ['Pipe Size', stormResults.pipeSize + ' mm'],
    ['Pipe Quantity', stormResults.pipeQuantity],
    [],
    ['Costs'],
    ['Total Material Cost', costResults.totalMaterialCost],
    ['Total Labor Cost', costResults.totalLaborCost],
    ['Total Project Cost', costResults.totalCost]
  ];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, 'Report');
  XLSX.writeFile(wb, (document.getElementById('projectName').value||'project').replace(/[^a-z0-9]/gi,'_') + '_Report.xlsx');
}

/* -----------------------
  Save/Load JSON file
-------------------------*/
function saveProjectAsJSON(){
  const data = {
    projectName: document.getElementById('projectName').value,
    clientName: document.getElementById('clientName').value,
    projectLocation: document.getElementById('projectLocation').value,
    preparedBy: document.getElementById('preparedBy').value,
    currency: document.getElementById('currency').value,
    codeStandard: document.getElementById('codeStandard').value,
    units: document.getElementById('units').value,
    // sanitary
    wc: document.getElementById('wc').value,
    lav: document.getElementById('lav').value,
    sink: document.getElementById('sink').value,
    shower: document.getElementById('shower').value,
    tub: document.getElementById('tub').value,
    urinal: document.getElementById('urinal').value,
    floorDrain: document.getElementById('floorDrain').value,
    sanLength: document.getElementById('sanLength').value,
    sanPipeMaterial: document.getElementById('sanPipeMaterial').value,
    sanPipeLength: document.getElementById('sanPipeLength').value,
    sanSlope: document.getElementById('sanSlope').value,
    // storm
    roofArea: document.getElementById('roofArea').value,
    pavementArea: document.getElementById('pavementArea').value,
    coef: document.getElementById('coef').value,
    intensity: document.getElementById('intensity').value,
    stormLength: document.getElementById('stormLength').value,
    stormPipeMaterial: document.getElementById('stormPipeMaterial').value,
    stormPipeLength: document.getElementById('stormPipeLength').value,
    stormSlope: document.getElementById('stormSlope').value,
    // costs & labor
    trapCost: document.getElementById('trapCost').value,
    ventCost: document.getElementById('ventCost').value,
    cleanoutCost: document.getElementById('cleanoutCost').value,
    manholeCost: document.getElementById('manholeCost').value,
    fittingCost: document.getElementById('fittingCost').value,
    downspoutCost: document.getElementById('downspoutCost').value,
    catchBasinCost: document.getElementById('catchBasinCost').value,
    plumberRate: document.getElementById('plumberRate').value,
    helperRate: document.getElementById('helperRate').value,
    numPlumbers: document.getElementById('numPlumbers').value,
    numHelpers: document.getElementById('numHelpers').value,
    dailyHours: document.getElementById('dailyHours').value,
    productivityPipe: document.getElementById('productivityPipe').value,
    productivityManhole: document.getElementById('productivityManhole').value,
    productivityFitting: document.getElementById('productivityFitting').value,
    wasteFactor: document.getElementById('wasteFactor').value,
    overhead: document.getElementById('overhead').value,
    profitMargin: document.getElementById('profitMargin').value,
    // pipe costs array
    sanitaryPipes: Array.from(document.getElementById('sanitaryPipesContainer').getElementsByClassName('pipe-cost-row')||[]).map(div=>{
      return { size: div.querySelector('.size-select').value, cost: div.querySelector('.cost-input').value };
    }),
    stormPipes: Array.from(document.getElementById('stormPipesContainer').getElementsByClassName('pipe-cost-row')||[]).map(div=>{
      return { size: div.querySelector('.size-select').value, cost: div.querySelector('.cost-input').value };
    })
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (document.getElementById('projectName').value||'project').replace(/[^a-z0-9]/gi,'_') + '_sanitary_project.json';
  a.click();
}

function loadProjectFromJSON(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const data = JSON.parse(e.target.result);
      // units: convert values if units differ
      const prevUnits = document.getElementById('units').value;
      if(data.units && data.units !== prevUnits){
        document.getElementById('units').value = data.units;
        convertVisibleValuesToUnits(prevUnits, data.units);
        window._lastUnits = data.units;
      }

      // sanitary
      if('wc' in data) document.getElementById('wc').value = data.wc;
      if('lav' in data) document.getElementById('lav').value = data.lav;
      if('sink' in data) document.getElementById('sink').value = data.sink;
      if('shower' in data) document.getElementById('shower').value = data.shower;
      if('tub' in data) document.getElementById('tub').value = data.tub;
      if('urinal' in data) document.getElementById('urinal').value = data.urinal;
      if('floorDrain' in data) document.getElementById('floorDrain').value = data.floorDrain;
      if('sanLength' in data) document.getElementById('sanLength').value = data.sanLength;
      if('sanPipeMaterial' in data) document.getElementById('sanPipeMaterial').value = data.sanPipeMaterial;
      if('sanPipeLength' in data) document.getElementById('sanPipeLength').value = data.sanPipeLength;
      if('sanSlope' in data) document.getElementById('sanSlope').value = data.sanSlope;

      // storm
      if('roofArea' in data) document.getElementById('roofArea').value = data.roofArea;
      if('pavementArea' in data) document.getElementById('pavementArea').value = data.pavementArea;
      if('coef' in data) document.getElementById('coef').value = data.coef;
      if('intensity' in data) document.getElementById('intensity').value = data.intensity;
      if('stormLength' in data) document.getElementById('stormLength').value = data.stormLength;
      if('stormPipeMaterial' in data) document.getElementById('stormPipeMaterial').value = data.stormPipeMaterial;
      if('stormPipeLength' in data) document.getElementById('stormPipeLength').value = data.stormPipeLength;
      if('stormSlope' in data) document.getElementById('stormSlope').value = data.stormSlope;

      // costs & labor
      if('trapCost' in data) document.getElementById('trapCost').value = data.trapCost;
      if('ventCost' in data) document.getElementById('ventCost').value = data.ventCost;
      if('cleanoutCost' in data) document.getElementById('cleanoutCost').value = data.cleanoutCost;
      if('manholeCost' in data) document.getElementById('manholeCost').value = data.manholeCost;
      if('fittingCost' in data) document.getElementById('fittingCost').value = data.fittingCost;
      if('downspoutCost' in data) document.getElementById('downspoutCost').value = data.downspoutCost;
      if('catchBasinCost' in data) document.getElementById('catchBasinCost').value = data.catchBasinCost;
      if('plumberRate' in data) document.getElementById('plumberRate').value = data.plumberRate;
      if('helperRate' in data) document.getElementById('helperRate').value = data.helperRate;
      if('numPlumbers' in data) document.getElementById('numPlumbers').value = data.numPlumbers;
      if('numHelpers' in data) document.getElementById('numHelpers').value = data.numHelpers;
      if('dailyHours' in data) document.getElementById('dailyHours').value = data.dailyHours;
      if('productivityPipe' in data) document.getElementById('productivityPipe').value = data.productivityPipe;
      if('productivityManhole' in data) document.getElementById('productivityManhole').value = data.productivityManhole;
      if('productivityFitting' in data) document.getElementById('productivityFitting').value = data.productivityFitting;
      if('wasteFactor' in data) document.getElementById('wasteFactor').value = data.wasteFactor;
      if('overhead' in data) document.getElementById('overhead').value = data.overhead;
      if('profitMargin' in data) document.getElementById('profitMargin').value = data.profitMargin;

      if(Array.isArray(data.sanitaryPipes)){
        const container = document.getElementById('sanitaryPipesContainer');
        container.innerHTML = '';
        data.sanitaryPipes.forEach(p=>{
          const div = document.createElement('div'); div.className='pipe-cost-row';
          div.innerHTML = `<select class="size-select">
            <option value="50"${p.size==='50'?' selected':''}>50 mm</option>
            <option value="75"${p.size==='75'?' selected':''}>75 mm</option>
            <option value="100"${p.size==='100'?' selected':''}>100 mm</option>
            <option value="150"${p.size==='150'?' selected':''}>150 mm</option>
            <option value="200"${p.size==='200'?' selected':''}>200 mm</option>
          </select>
          <input class="cost-input" type="number" min="0" step="0.01" value="${p.cost||0}" />
          <button class="remove-pipe-btn" onclick="this.parentElement.remove()">Remove</button>`;
          container.appendChild(div);
        });
      }
      if(Array.isArray(data.stormPipes)){
        const container = document.getElementById('stormPipesContainer');
        container.innerHTML = '';
        data.stormPipes.forEach(p=>{
          const div = document.createElement('div'); div.className='pipe-cost-row';
          div.innerHTML = `<select class="size-select">
            <option value="75"${p.size==='75'?' selected':''}>75 mm</option>
            <option value="100"${p.size==='100'?' selected':''}>100 mm</option>
            <option value="150"${p.size==='150'?' selected':''}>150 mm</option>
            <option value="200"${p.size==='200'?' selected':''}>200 mm</option>
            <option value="250"${p.size==='250'?' selected':''}>250 mm</option>
          </select>
          <input class="cost-input" type="number" min="0" step="0.01" value="${p.cost||0}" />
          <button class="remove-pipe-btn" onclick="this.parentElement.remove()">Remove</button>`;
          container.appendChild(div);
        });
      }

      setTimeout(()=>{ alert('Project loaded from JSON. You may now re-run calculations.'); }, 50);
    }catch(err){
      alert('Invalid JSON file: ' + err.message);
      console.error(err);
    }
  };
  reader.readAsText(file);
}

/* -----------------------
  Reset
-------------------------*/
function resetCalculator(){
  if(!confirm('Reset calculator to defaults?')) return;
  location.reload();
}
</script>
</body>
</html>
