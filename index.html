<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hot & Cold Water Distribution Calculator</title>

<!-- jsPDF and autotable for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#2563eb;
  --primary-dark:#1d4ed8;
  --secondary:#64748b;
  --light:#f8fafc;
  --dark:#0f172a;
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
  --border:#cbd5c1;
}
body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f1f5f9;color:var(--dark);padding:20px}
.container{max-width:1200px;margin:0 auto}
header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:20px;border-radius:10px;margin-bottom:20px}
h1{font-size:1.8rem;margin:0}
.subtitle{opacity:.9;margin-top:6px}
.disclaimer{background:#fff3cd;border:1px solid #ffeaa7;padding:10px;border-radius:6px;margin-top:10px;color:#000}
.tabs{display:flex;border-bottom:1px solid var(--border);gap:6px;flex-wrap:wrap;margin-bottom:12px}
.tab{padding:8px 14px;cursor:pointer;border-bottom:3px solid transparent}
.tab.active{border-bottom:3px solid var(--primary);font-weight:600;color:var(--primary)}
.tab-content{display:none}
.tab-content.active{display:block}
.section{background:#fff;padding:18px;border-radius:8px;border:1px solid var(--border);margin-bottom:18px}
.form-row{display:flex;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
.form-row label{flex:0 0 190px;font-weight:600;text-align:right}
.input-group{flex:1;display:flex;gap:8px;align-items:center}
.input-group input,.input-group select{flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);min-width:0}
.unit{flex:0 0 70px;font-weight:600}
.button-group{display:flex;gap:10px;margin-top:10px}
button{padding:10px 14px;border-radius:6px;border:none;background:var(--primary);color:#fff;cursor:pointer}
button.secondary{background:var(--secondary)}
.output{margin-top:12px;padding:12px;border-radius:6px;background:#f8fafe;border-left:4px solid var(--primary);display:none}
.pipe-cost-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.size-select{width:90px}
.cost-input{width:130px}
.add-pipe-btn{background:var(--success);color:#fff;padding:8px;border-radius:6px;border:none}
.remove-pipe-btn{background:var(--danger);color:#fff;padding:6px;border-radius:6px;border:none}
.summary-card{background:#fff;padding:14px;border-radius:8px;margin-bottom:12px;border:1px solid var(--border);display:none}
.reference-table{width:100%;border-collapse:collapse;margin-top:10px}
.reference-table th,.reference-table td{padding:8px;border:1px solid #ddd}
.formula{font-family:monospace;background:#f8fafc;padding:8px;border-radius:6px;border-left:3px solid var(--primary)}
.grey-header{background:#e0e0e0;font-weight:bold}
.hidden-file{display:none}

/* Water Distribution Specific Styles */
.fixture-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px}
.pipe-run-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;padding:8px;background:#f8fafc;border-radius:6px}
.pipe-run-select{flex:1}
.pipe-run-input{width:120px}
.settings-block{margin-top:8px;padding:12px;background:#fbfbfb;border-radius:6px;border:1px dashed #eee}
.auto-defaults-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-top:8px}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Hot & Cold Water Distribution Calculator</h1>
    <div class="subtitle">Quantity takeoff for plumbing contractors & estimators — water supply systems</div>
    <div class="disclaimer">
      <strong>Note:</strong> This calculator provides estimates based on standard practices. Always consult local codes and project specifications.
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="project">Project Info</div>
    <div class="tab" data-tab="water-system">Water System</div>
    <div class="tab" data-tab="costs">Costs & Labor</div>
    <div class="tab" data-tab="summary">Summary & Export</div>
    <div class="tab" data-tab="help">Help & Reference</div>
  </div>

  <!-- Project Info -->
  <div id="project" class="tab-content active">
    <div class="section">
      <h2>Project Information</h2>
      <div class="form-row">
        <label>Project Name:</label>
        <div class="input-group"><input id="projectName" type="text" value="Residential Water System Project"></div>
      </div>
      <div class="form-row">
        <label>Client Name:</label>
        <div class="input-group"><input id="clientName" type="text" value="John Dela Cruz"></div>
      </div>
      <div class="form-row">
        <label>Location:</label>
        <div class="input-group"><input id="projectLocation" type="text" value="Manila, Philippines"></div>
      </div>
      <div class="form-row">
        <label>Prepared By:</label>
        <div class="input-group"><input id="preparedBy" type="text" value="Maria Santos, Civil Engineer"></div>
      </div>
      <div class="form-row">
        <label>Currency:</label>
        <div class="input-group">
          <select id="currency"><option value="PHP">Philippine Peso (₱)</option><option value="USD">US Dollar ($)</option><option value="EUR">Euro (€)</option><option value="JPY">Yen (¥)</option></select>
        </div>
      </div>
      <div class="form-row">
        <label>Plumbing Code Standard:</label>
        <div class="input-group">
          <select id="codeStandard"><option value="npcp">RNPCP (Philippines)</option><option value="ipc">IPC</option><option value="upc">UPC</option></select>
        </div>
      </div>
      <div class="form-row">
        <label>Measurement Units:</label>
        <div class="input-group">
          <select id="units"><option value="metric">Metric (m, mm)</option><option value="imperial">Imperial (ft, in)</option></select>
        </div>
      </div>

      <div class="button-group">
        <button onclick="saveProjectAsJSON()">Save Project (JSON)</button>
        <button class="secondary" onclick="document.getElementById('jsonFileInput').click()">Load Project (JSON)</button>
        <input id="jsonFileInput" type="file" accept=".json,application/json" class="hidden-file" onchange="loadProjectFromJSON(event)">
        <button class="secondary" onclick="resetCalculator()" style="background-color:var(--danger)">Reset</button>
      </div>
    </div>
  </div>

  <!-- Water System -->
  <div id="water-system" class="tab-content">
    <div class="section">
      <h2>Water Distribution System</h2>
      
      <h3>Pipe Runs Configuration</h3>
      <div class="section">
        <strong>Add Pipe Runs (as many as needed)</strong>
        <div id="pipeRunsContainer">
          <!-- Pipe runs will be added here dynamically -->
        </div>
        <div class="button-group">
          <button class="add-pipe-btn" onclick="addPipeRun()">+ Add Pipe Run</button>
          <button class="secondary" onclick="seedSampleRuns()">Seed Sample</button>
          <button class="secondary" onclick="clearPipeRuns()" style="background-color:var(--danger)">Clear All</button>
        </div>
      </div>

      <h3>Fixture Count</h3>
      <div class="section">
        <h4>Bathroom Fixtures</h4>
        <div class="fixture-grid">
          <div class="form-row">
            <label>Lavatory:</label>
            <div class="input-group"><input id="f_lavatory" type="number" min="0" value="2"></div>
          </div>
          <div class="form-row">
            <label>Water Closet:</label>
            <div class="input-group"><input id="f_water_closet" type="number" min="0" value="2"></div>
          </div>
          <div class="form-row">
            <label>Bathtub:</label>
            <div class="input-group"><input id="f_bathtub" type="number" min="0" value="1"></div>
          </div>
          <div class="form-row">
            <label>Shower:</label>
            <div class="input-group"><input id="f_shower" type="number" min="0" value="1"></div>
          </div>
          <div class="form-row">
            <label>Bidet:</label>
            <div class="input-group"><input id="f_bidet" type="number" min="0" value="0"></div>
          </div>
          <div class="form-row">
            <label>Urinal:</label>
            <div class="input-group"><input id="f_urinal" type="number" min="0" value="0"></div>
          </div>
        </div>

        <h4>Kitchen Fixtures</h4>
        <div class="fixture-grid">
          <div class="form-row">
            <label>Kitchen Sink:</label>
            <div class="input-group"><input id="f_kitchen_sink" type="number" min="0" value="1"></div>
          </div>
          <div class="form-row">
            <label>Dishwasher:</label>
            <div class="input-group"><input id="f_dishwasher" type="number" min="0" value="0"></div>
          </div>
        </div>

        <h4>General Fixtures</h4>
        <div class="fixture-grid">
          <div class="form-row">
            <label>Drinking Fountain:</label>
            <div class="input-group"><input id="f_drinking_fountain" type="number" min="0" value="0"></div>
          </div>
          <div class="form-row">
            <label>Service Sink:</label>
            <div class="input-group"><input id="f_service_sink" type="number" min="0" value="0"></div>
          </div>
          <div class="form-row">
            <label>Floor Drain:</label>
            <div class="input-group"><input id="f_floor_drain" type="number" min="0" value="0"></div>
          </div>
        </div>
      </div>

      <h3>Calculation Settings</h3>
      <div class="section settings-block">
        <div class="form-row">
          <label>Commercial Pipe Length:</label>
          <div class="input-group">
            <input id="stickLength" type="number" min="1" step="0.1" value="6">
            <div class="unit" id="stickLengthUnit">m</div>
          </div>
        </div>
        <div class="form-row">
          <label>Waste Allowance:</label>
          <div class="input-group">
            <input id="wastePct" type="number" min="0" max="50" value="10">
            <div class="unit">%</div>
          </div>
        </div>
        <div class="form-row">
          <label>Building Type:</label>
          <div class="input-group">
            <select id="buildingType">
              <option value="single">Single-storey</option>
              <option value="multi">Multi-storey</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <label>Calculation Mode:</label>
          <div class="input-group">
            <label><input type="radio" name="calcMode" value="auto" checked> Auto Calculation</label>
            <label><input type="radio" name="calcMode" value="manual"> Manual Input</label>
          </div>
        </div>

        <div id="autoDefaults">
          <h4>Auto Calculation Defaults</h4>
          <div class="auto-defaults-grid">
            <div class="form-row">
              <label>Elbows per run:</label>
              <div class="input-group"><input id="d_elbow_per_run" type="number" step="0.1" min="0" value="1"></div>
            </div>
            <div class="form-row">
              <label>Tees per fixture:</label>
              <div class="input-group"><input id="d_tee_per_fixture" type="number" step="0.1" min="0" value="1"></div>
            </div>
            <div class="form-row">
              <label>Couplings per stick:</label>
              <div class="input-group"><input id="d_coupling_per_stick" type="number" step="0.1" min="0" value="1"></div>
            </div>
            <div class="form-row">
              <label>Female Tees per fixture:</label>
              <div class="input-group"><input id="d_femtee_per_fixture" type="number" step="0.1" min="0" value="0.5"></div>
            </div>
            <div class="form-row">
              <label>Male Adapters per fixture:</label>
              <div class="input-group"><input id="d_maleadapter_per_fixture" type="number" step="0.1" min="0" value="0.5"></div>
            </div>
            <div class="form-row">
              <label>Stop Valves per fixture:</label>
              <div class="input-group"><input id="d_stop_per_fixture" type="number" step="0.1" min="0" value="1"></div>
            </div>
          </div>
        </div>

        <div id="manualInputs" style="display: none;">
          <h4>Manual Quantities</h4>
          <div class="auto-defaults-grid">
            <div class="form-row">
              <label>Elbows:</label>
              <div class="input-group"><input id="m_elbows" type="number" min="0" value="0"></div>
            </div>
            <div class="form-row">
              <label>Tees:</label>
              <div class="input-group"><input id="m_tees" type="number" min="0" value="0"></div>
            </div>
            <div class="form-row">
              <label>Couplings:</label>
              <div class="input-group"><input id="m_couplings" type="number" min="0" value="0"></div>
            </div>
            <div class="form-row">
              <label>Female Tees:</label>
              <div class="input-group"><input id="m_femtees" type="number" min="0" value="0"></div>
            </div>
            <div class="form-row">
              <label>Male Adapters:</label>
              <div class="input-group"><input id="m_maleadap" type="number" min="0" value="0"></div>
            </div>
            <div class="form-row">
              <label>Stop Valves:</label>
              <div class="input-group"><input id="m_stops" type="number" min="0" value="0"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button onclick="calculateWaterSystem()">Calculate Water System</button>
      </div>
      <div id="waterSystemOutput" class="output"></div>
    </div>
  </div>

  <!-- Costs & Labor -->
  <div id="costs" class="tab-content">
    <div class="section">
      <h2>Costs & Labor Estimations</h2>

      <div class="material-costs">
        <h3>Material Costs</h3>
        <div>
          <h4>Pipe Costs</h4>
          <div id="waterPipesContainer"></div>
          <button class="add-pipe-btn" onclick="addWaterPipeCost()">+ Add Pipe Cost</button>
        </div>

        <div style="margin-top:12px">
          <h4>Fitting Costs (unit cost)</h4>
          <div class="form-row"><label>Elbow Cost:</label><div class="input-group"><input id="elbowCost" type="number" min="0" step="0.01" value="50"></div></div>
          <div class="form-row"><label>Tee Cost:</label><div class="input-group"><input id="teeCost" type="number" min="0" step="0.01" value="60"></div></div>
          <div class="form-row"><label>Coupling Cost:</label><div class="input-group"><input id="couplingCost" type="number" min="0" step="0.01" value="40"></div></div>
          <div class="form-row"><label>Female Tee Cost:</label><div class="input-group"><input id="femTeeCost" type="number" min="0" step="0.01" value="80"></div></div>
          <div class="form-row"><label>Male Adapter Cost:</label><div class="input-group"><input id="maleAdapterCost" type="number" min="0" step="0.01" value="45"></div></div>
          <div class="form-row"><label>Stop Valve Cost:</label><div class="input-group"><input id="stopValveCost" type="number" min="0" step="0.01" value="120"></div></div>
          <div class="form-row"><label>Pipe Insulation Cost (per m):</label><div class="input-group"><input id="insulationCost" type="number" min="0" step="0.01" value="25"></div></div>
        </div>
      </div>

      <div style="margin-top:14px">
        <h3>Labor Inputs & Productivity</h3>
        <div class="form-row"><label>Plumber Hourly Rate:</label><div class="input-group"><input id="plumberRate" type="number" min="0" step="0.1" value="80"></div></div>
        <div class="form-row"><label>Helper Hourly Rate:</label><div class="input-group"><input id="helperRate" type="number" min="0" step="0.1" value="50"></div></div>

        <div class="form-row"><label>Number of Plumbers:</label><div class="input-group"><input id="numPlumbers" type="number" min="1" step="1" value="2"></div></div>
        <div class="form-row"><label>Number of Helpers:</label><div class="input-group"><input id="numHelpers" type="number" min="0" step="1" value="1"></div></div>

        <div class="form-row"><label>Daily Work Hours:</label><div class="input-group"><input id="dailyHours" type="number" min="1" max="12" value="8"></div></div>

        <div class="form-row"><label>Pipe installation productivity:</label><div class="input-group"><input id="productivityPipe" type="number" min="0.01" step="0.1" value="15"><div class="unit" id="productivityPipeUnit">m/day</div></div></div>
        <div class="form-row"><label>Fitting installation productivity:</label><div class="input-group"><input id="productivityFitting" type="number" min="0.01" step="0.1" value="25"><div class="unit">pcs/day</div></div></div>

        <div class="form-row"><label>Waste Factor (%):</label><div class="input-group"><input id="wasteFactor" type="number" min="0" max="50" value="5"></div></div>
        <div class="form-row"><label>Overhead (%):</label><div class="input-group"><input id="overhead" type="number" min="0" max="50" value="15"></div></div>
        <div class="form-row"><label>Profit Margin (%):</label><div class="input-group"><input id="profitMargin" type="number" min="0" max="50" value="10"></div></div>
      </div>

      <div class="button-group"><button onclick="calculateCosts()">Calculate Total Costs</button></div>
      <div id="costsOutput" class="output"></div>
    </div>
  </div>

  <!-- Summary & Export -->
  <div id="summary" class="tab-content">
    <div class="section">
      <h2>Summary & Export</h2>
      <div class="button-group">
        <button onclick="generateSummary()">Generate Summary</button>
        <button class="secondary" onclick="exportToPDF()">Export to PDF</button>
        <button class="secondary" onclick="exportToExcel()">Export to Excel</button>
      </div>

      <div id="projectSummaryCard" class="summary-card"><h3>Project Summary</h3><div id="projectSummary"></div></div>
      <div id="waterSystemSummaryCard" class="summary-card"><h3>Water System Summary</h3><div id="waterSystemSummary"></div></div>
      <div id="costBreakdownCard" class="summary-card"><h3>Cost Breakdown</h3>
        <table class="reference-table" id="costBreakdownTable">
          <thead><tr><th>Item</th><th>Quantity</th><th>Unit Cost</th><th>Total Cost</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="laborSummaryCard" class="summary-card"><h3>Labor Requirements</h3><div id="laborSummary"></div></div>
    </div>
  </div>

  <!-- Help & Reference -->
  <div id="help" class="tab-content">
    <div class="section">
      <h2>Help & Reference</h2>
      
      <h3>How to Use This Calculator</h3>
      <div class="formula" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin-top: 0;">Step-by-Step Guide:</h4>
        <ol>
          <li><strong>Project Info:</strong> Enter basic project details and select units</li>
          <li><strong>Water System:</strong> Add pipe runs and input fixture counts</li>
          <li><strong>Costs & Labor:</strong> Configure material costs and labor rates</li>
          <li><strong>Summary & Export:</strong> Generate comprehensive report and export</li>
        </ol>
      </div>

      <h3>Pipe Material Reference</h3>
      <h4>Hot Water Distribution Pipes (HWL)</h4>
      <ul>
        <li><strong>Copper Pipes</strong> – Durable, corrosion-resistant, top choice for hot water</li>
        <li><strong>CPVC</strong> – Treated to withstand heat, common modern option</li>
        <li><strong>PPR</strong> – Heat-resistant, widely used in modern systems</li>
        <li><strong>PEX</strong> – Flexible, easy to install, reliable for hot water</li>
        <li><strong>Stainless Steel</strong> – Highly durable, corrosion-resistant</li>
      </ul>

      <h4>Cold Water Distribution Pipes (CWL)</h4>
      <ul>
        <li><strong>uPVC</strong> – Rigid, great for potable cold water lines</li>
        <li><strong>HDPE</strong> – Strong and flexible, ideal for cold water supply</li>
        <li><strong>PPR</strong> – Works well for potable cold water</li>
        <li><strong>PEX</strong> – Flexible and reliable for cold water</li>
      </ul>

      <h3>Fitting Types</h3>
      <table class="reference-table">
        <thead><tr><th>Fitting</th><th>Purpose</th></tr></thead>
        <tbody>
          <tr><td>Elbow (90°)</td><td>Change pipe direction by 90°</td></tr>
          <tr><td>Tee</td><td>Connect three pipes for branching</td></tr>
          <tr><td>Coupling</td><td>Join two pipes in straight line</td></tr>
          <tr><td>Female Tee</td><td>Tee with female threads</td></tr>
          <tr><td>Male Adapter</td><td>Adapt female to male threads</td></tr>
          <tr><td>Stop Valve</td><td>Control water flow at fixtures</td></tr>
        </tbody>
      </table>

      <h3>Calculation Formulas</h3>
      <div class="formula">Total Pipe Length = Σ(Individual Run Lengths)</div>
      <div class="formula">Pipe Sticks = CEILING(Total Length × (1 + Waste%) ÷ Commercial Length)</div>
      <div class="formula">Fittings Quantity = (Runs × Defaults) + (Fixtures × Defaults)</div>
      <div class="formula">Hot Water Insulation = Total HWL Length × (1 + Waste%)</div>

      <h3>Best Practices</h3>
      <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
        <ul>
          <li>Always insulate hot water pipes to conserve energy</li>
          <li>Use dielectric unions when connecting dissimilar metals</li>
          <li>Follow manufacturer recommendations for joining methods</li>
          <li>Consider expansion loops in long hot water runs</li>
          <li>Verify local code requirements for material approvals</li>
        </ul>
      </div>

      <div class="disclaimer" style="margin-top: 20px;">
        <strong>Important:</strong> This calculator provides estimates. Always consult local codes, regulations, and licensed professionals for formal design.
      </div>
    </div>
  </div>

</div>

<script>
// Global state
let waterSystemResults = null;
let costResults = null;
let laborResults = null;

// Pipe types configuration
const PIPE_TYPES = {
    'CWL': ['uPVC', 'HDPE', 'PPR', 'PEX', 'Galvanized Iron'],
    'HWL': ['Copper', 'CPVC', 'PPR', 'PEX', 'Galvanized Steel', 'Stainless Steel']
};

// Utility functions
function safeNumber(v, fallback=0) {
    const n = Number(v);
    if (isNaN(n)) return fallback;
    return n;
}

function formatNumber(num, dp=2) {
    if (typeof num !== 'number' || isNaN(num)) return '';
    const rounded = Math.round((num+Number.EPSILON)*Math.pow(10,dp))/Math.pow(10,dp);
    return rounded.toLocaleString(undefined, {minimumFractionDigits: dp, maximumFractionDigits: dp});
}

function formatCurrency(n) {
    if (typeof n !== 'number' || isNaN(n)) return '';
    const c = document.getElementById('currency').value;
    const symbol = c === 'PHP' ? '₱' : (c === 'USD' ? '$' : (c === 'EUR' ? '€' : '¥'));
    return symbol + ' ' + formatNumber(n,2);
}

function formatCurrencyForPDF(n) {
    if (typeof n !== 'number' || isNaN(n)) return '';
    const c = document.getElementById('currency').value;
    const prefix = c === 'PHP' ? 'PHP ' : (c==='USD'? '$ ' : (c==='EUR' ? 'EUR ' : 'JPY '));
    return prefix + formatNumber(n,2);
}

// Tab functionality
document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', function(){
        const tab = this.getAttribute('data-tab');
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
    });
});

// Unit conversion
function setUnitLabels() {
    const units = document.getElementById('units').value;
    document.getElementById('stickLengthUnit').textContent = units==='metric' ? 'm' : 'ft';
    document.getElementById('productivityPipeUnit').textContent = units==='metric' ? 'm/day' : 'ft/day';
}

// Initialize
document.addEventListener('DOMContentLoaded', ()=>{
    addWaterPipeCost();
    setUnitLabels();
    seedSampleRuns();
    document.getElementById('units').addEventListener('change', setUnitLabels);
    
    // Toggle auto/manual mode
    document.querySelectorAll('input[name="calcMode"]').forEach(r => {
        r.addEventListener('change', () => {
            const mode = document.querySelector('input[name="calcMode"]:checked').value;
            document.getElementById('autoDefaults').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('manualInputs').style.display = mode === 'manual' ? 'block' : 'none';
        });
    });
});

// Pipe Run Management
function addPipeRun(pref = {}) {
    const container = document.getElementById('pipeRunsContainer');
    const div = document.createElement('div');
    div.className = 'pipe-run-row';
    
    // System select
    const sysSelect = document.createElement('select');
    sysSelect.className = 'pipe-run-select';
    ['CWL - Cold Water Line', 'HWL - Hot Water Line'].forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if (pref.sys && pref.sys === s) opt.selected = true;
        sysSelect.appendChild(opt);
    });
    
    // Pipe type select
    const pipeSelect = document.createElement('select');
    pipeSelect.className = 'pipe-run-select';
    pipeSelect.disabled = true;
    
    // Length input
    const lenInput = document.createElement('input');
    lenInput.type = 'number';
    lenInput.className = 'pipe-run-input';
    lenInput.step = '0.1';
    lenInput.min = '0';
    lenInput.placeholder = 'Length';
    if (pref.len) lenInput.value = pref.len;
    
    // Notes input
    const noteInput = document.createElement('input');
    noteInput.type = 'text';
    noteInput.className = 'pipe-run-input';
    noteInput.placeholder = 'Notes';
    if (pref.note) noteInput.value = pref.note;
    
    // Remove button
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-pipe-btn';
    removeBtn.textContent = 'Remove';
    removeBtn.onclick = () => div.remove();
    
    // System change handler
    sysSelect.addEventListener('change', () => {
        const system = sysSelect.value.includes('HWL') ? 'HWL' : 'CWL';
        pipeSelect.innerHTML = '';
        PIPE_TYPES[system].forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            if (pref.pipe && pref.pipe === p) opt.selected = true;
            pipeSelect.appendChild(opt);
        });
        pipeSelect.disabled = false;
    });
    
    div.appendChild(sysSelect);
    div.appendChild(pipeSelect);
    div.appendChild(lenInput);
    div.appendChild(noteInput);
    div.appendChild(removeBtn);
    container.appendChild(div);
    
    // Trigger initial population
    sysSelect.dispatchEvent(new Event('change'));
}

function seedSampleRuns() {
    addPipeRun({ sys: 'CWL - Cold Water Line', pipe: 'uPVC', len: 18, note: 'Main from meter' });
    addPipeRun({ sys: 'CWL - Cold Water Line', pipe: 'PEX', len: 6, note: 'Branch to kitchen' });
    addPipeRun({ sys: 'HWL - Hot Water Line', pipe: 'Copper', len: 12, note: 'Hot riser to floor' });
}

function clearPipeRuns() {
    document.getElementById('pipeRunsContainer').innerHTML = '';
}

// Water System Calculation
function calculateWaterSystem() {
    const runs = Array.from(document.querySelectorAll('#pipeRunsContainer .pipe-run-row'));
    if (runs.length === 0) {
        alert('Please add at least one pipe run.');
        return;
    }

    // Collect pipe runs data
    const pipeData = {};
    runs.forEach(run => {
        const sysSelect = run.querySelector('select:nth-child(1)');
        const pipeSelect = run.querySelector('select:nth-child(2)');
        const lenInput = run.querySelector('input[type="number"]');
        const noteInput = run.querySelector('input[type="text"]');
        
        const system = sysSelect.value.includes('HWL') ? 'HWL' : 'CWL';
        const pipeType = pipeSelect.value;
        const length = safeNumber(lenInput.value, 0);
        const note = noteInput.value || '';
        
        const key = `${system}||${pipeType}`;
        if (!pipeData[key]) {
            pipeData[key] = { system, pipeType, totalLength: 0, runs: 0, notes: [] };
        }
        pipeData[key].totalLength += length;
        pipeData[key].runs += 1;
        if (note) pipeData[key].notes.push(note);
    });

    // Fixture counts
    const fixtures = {
        lavatory: safeNumber(document.getElementById('f_lavatory').value, 0),
        water_closet: safeNumber(document.getElementById('f_water_closet').value, 0),
        bathtub: safeNumber(document.getElementById('f_bathtub').value, 0),
        shower: safeNumber(document.getElementById('f_shower').value, 0),
        bidet: safeNumber(document.getElementById('f_bidet').value, 0),
        urinal: safeNumber(document.getElementById('f_urinal').value, 0),
        kitchen_sink: safeNumber(document.getElementById('f_kitchen_sink').value, 0),
        dishwasher: safeNumber(document.getElementById('f_dishwasher').value, 0),
        drinking_fountain: safeNumber(document.getElementById('f_drinking_fountain').value, 0),
        service_sink: safeNumber(document.getElementById('f_service_sink').value, 0),
        floor_drain: safeNumber(document.getElementById('f_floor_drain').value, 0)
    };

    const totalFixtures = Object.values(fixtures).reduce((sum, val) => sum + val, 0);

    // Settings
    const stickLength = safeNumber(document.getElementById('stickLength').value, 6);
    const wastePct = safeNumber(document.getElementById('wastePct').value, 10) / 100;
    const buildingType = document.getElementById('buildingType').value;
    const mode = document.querySelector('input[name="calcMode"]:checked').value;

    // Calculate pipe quantities
    const pipeResults = {};
    let totalInsulation = 0;

    for (const key in pipeData) {
        const data = pipeData[key];
        const netLength = data.totalLength;
        const withWaste = netLength * (1 + wastePct);
        const sticks = Math.ceil(withWaste / stickLength);
        
        pipeResults[key] = {
            system: data.system,
            pipeType: data.pipeType,
            netLength,
            withWaste,
            sticks,
            runs: data.runs
        };

        if (data.system === 'HWL') {
            totalInsulation += withWaste;
        }
    }

    // Calculate fittings
    const fittings = {};
    
    if (mode === 'auto') {
        const d_elbow = safeNumber(document.getElementById('d_elbow_per_run').value, 1);
        const d_tee = safeNumber(document.getElementById('d_tee_per_fixture').value, 1);
        const d_coupling = safeNumber(document.getElementById('d_coupling_per_stick').value, 1);
        const d_femtee = safeNumber(document.getElementById('d_femtee_per_fixture').value, 0.5);
        const d_malead = safeNumber(document.getElementById('d_maleadapter_per_fixture').value, 0.5);
        const d_stop = safeNumber(document.getElementById('d_stop_per_fixture').value, 1);

        for (const key in pipeResults) {
            const pipe = pipeResults[key];
            const prefix = `${pipe.system} ${pipe.pipeType}`;
            
            fittings[`${prefix} - Elbows`] = Math.ceil(pipe.runs * d_elbow);
            fittings[`${prefix} - Couplings`] = Math.ceil(pipe.sticks * d_coupling);
        }

        fittings['CWL - Tees'] = Math.ceil(totalFixtures * d_tee);
        fittings['HWL - Tees'] = Math.ceil(totalFixtures * d_tee);
        fittings['CWL - Female Tees'] = Math.ceil(totalFixtures * d_femtee);
        fittings['HWL - Female Tees'] = Math.ceil(totalFixtures * d_femtee);
        fittings['CWL - Male Adapters'] = Math.ceil(totalFixtures * d_malead);
        fittings['HWL - Male Adapters'] = Math.ceil(totalFixtures * d_malead);
        fittings['CWL - Stop Valves'] = Math.ceil(totalFixtures * d_stop);
        fittings['HWL - Stop Valves'] = Math.ceil(totalFixtures * d_stop);
    } else {
        // Manual mode
        const manualFittings = {
            'Elbows': safeNumber(document.getElementById('m_elbows').value, 0),
            'Tees': safeNumber(document.getElementById('m_tees').value, 0),
            'Couplings': safeNumber(document.getElementById('m_couplings').value, 0),
            'Female Tees': safeNumber(document.getElementById('m_femtees').value, 0),
            'Male Adapters': safeNumber(document.getElementById('m_maleadap').value, 0),
            'Stop Valves': safeNumber(document.getElementById('m_stops').value, 0)
        };

        for (const [name, qty] of Object.entries(manualFittings)) {
            if (qty > 0) fittings[name] = qty;
        }
    }

    waterSystemResults = {
        pipeResults,
        fittings,
        fixtures,
        totalFixtures,
        totalInsulation,
        settings: { stickLength, wastePct: wastePct * 100, buildingType, mode }
    };

    // Display results
    displayWaterSystemResults();
}

function displayWaterSystemResults() {
    const output = document.getElementById('waterSystemOutput');
    let html = '<h3>Water System Results</h3>';

    // Pipes summary
    html += '<h4>Pipes Summary</h4><table class="reference-table"><tr><th>System</th><th>Pipe Type</th><th>Net Length</th><th>With Waste</th><th>Sticks</th><th>Runs</th></tr>';
    
    for (const key in waterSystemResults.pipeResults) {
        const pipe = waterSystemResults.pipeResults[key];
        html += `<tr>
            <td>${pipe.system}</td>
            <td>${pipe.pipeType}</td>
            <td>${formatNumber(pipe.netLength, 1)} m</td>
            <td>${formatNumber(pipe.withWaste, 1)} m</td>
            <td>${pipe.sticks}</td>
            <td>${pipe.runs}</td>
        </tr>`;
    }
    html += '</table>';

    // Fittings summary
    html += '<h4>Fittings Summary</h4><table class="reference-table"><tr><th>Fitting Type</th><th>Quantity</th></tr>';
    for (const [name, qty] of Object.entries(waterSystemResults.fittings)) {
        html += `<tr><td>${name}</td><td>${qty} pcs</td></tr>`;
    }
    html += '</table>';

    // Fixtures summary
    html += '<h4>Fixtures Summary</h4><table class="reference-table"><tr><th>Fixture Type</th><th>Quantity</th></tr>';
    for (const [name, qty] of Object.entries(waterSystemResults.fixtures)) {
        if (qty > 0) {
            const displayName = name.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<tr><td>${displayName}</td><td>${qty}</td></tr>`;
        }
    }
    html += `<tr><td><strong>Total Fixtures</strong></td><td><strong>${waterSystemResults.totalFixtures}</strong></td></tr>`;
    html += '</table>';

    // Additional info
    html += `<h4>Additional Requirements</h4>`;
    html += `<p><strong>Hot Water Insulation:</strong> ${formatNumber(waterSystemResults.totalInsulation, 1)} m</p>`;
    html += `<p><strong>Calculation Mode:</strong> ${waterSystemResults.settings.mode === 'auto' ? 'Auto' : 'Manual'}</p>`;

    output.innerHTML = html;
    output.style.display = 'block';
}

// Cost calculation functions
function addWaterPipeCost() {
    const container = document.getElementById('waterPipesContainer');
    const div = document.createElement('div');
    div.className = 'pipe-cost-row';
    div.innerHTML = `
        <select class="size-select">
            <option value="15">15 mm</option>
            <option value="20">20 mm</option>
            <option value="25" selected>25 mm</option>
            <option value="32">32 mm</option>
            <option value="40">40 mm</option>
            <option value="50">50 mm</option>
        </select>
        <select class="size-select">
            <option value="uPVC">uPVC</option>
            <option value="HDPE">HDPE</option>
            <option value="PPR">PPR</option>
            <option value="PEX">PEX</option>
            <option value="Copper">Copper</option>
            <option value="CPVC">CPVC</option>
        </select>
        <input class="cost-input" type="number" min="0" step="0.01" value="800">
        <button class="remove-pipe-btn" onclick="this.parentElement.remove()">Remove</button>
    `;
    container.appendChild(div);
}

function calculateCosts() {
    if (!waterSystemResults) {
        alert('Please calculate water system first.');
        return;
    }

    // Get cost inputs
    const plumberRate = safeNumber(document.getElementById('plumberRate').value, 80);
    const helperRate = safeNumber(document.getElementById('helperRate').value, 50);
    const numPlumbers = safeNumber(document.getElementById('numPlumbers').value, 2);
    const numHelpers = safeNumber(document.getElementById('numHelpers').value, 1);
    const dailyHours = safeNumber(document.getElementById('dailyHours').value, 8);
    const productivityPipe = safeNumber(document.getElementById('productivityPipe').value, 15);
    const productivityFitting = safeNumber(document.getElementById('productivityFitting').value, 25);
    const wasteFactor = safeNumber(document.getElementById('wasteFactor').value, 5) / 100;
    const overhead = safeNumber(document.getElementById('overhead').value, 15) / 100;
    const profitMargin = safeNumber(document.getElementById('profitMargin').value, 10) / 100;

    // Get material costs
    const elbowCost = safeNumber(document.getElementById('elbowCost').value, 50);
    const teeCost = safeNumber(document.getElementById('teeCost').value, 60);
    const couplingCost = safeNumber(document.getElementById('couplingCost').value, 40);
    const femTeeCost = safeNumber(document.getElementById('femTeeCost').value, 80);
    const maleAdapterCost = safeNumber(document.getElementById('maleAdapterCost').value, 45);
    const stopValveCost = safeNumber(document.getElementById('stopValveCost').value, 120);
    const insulationCost = safeNumber(document.getElementById('insulationCost').value, 25);

    // Calculate pipe costs from pipe cost inputs
    let totalPipeCost = 0;
    const pipeCostRows = Array.from(document.getElementById('waterPipesContainer').getElementsByClassName('pipe-cost-row'));
    const pipeCostMap = {};
    
    pipeCostRows.forEach(row => {
        const size = row.querySelector('select:nth-child(1)').value;
        const material = row.querySelector('select:nth-child(2)').value;
        const cost = safeNumber(row.querySelector('.cost-input').value, 0);
        pipeCostMap[`${material}`] = cost;
    });

    // Calculate material costs
    let totalPipeMaterialCost = 0;
    let totalFittingCost = 0;
    
    // Pipe costs
    for (const key in waterSystemResults.pipeResults) {
        const pipe = waterSystemResults.pipeResults[key];
        const pipeCost = pipeCostMap[pipe.pipeType] || 0;
        totalPipeMaterialCost += pipe.sticks * pipeCost;
    }

    // Fitting costs
    for (const [fittingName, qty] of Object.entries(waterSystemResults.fittings)) {
        let unitCost = 0;
        if (fittingName.includes('Elbow')) unitCost = elbowCost;
        else if (fittingName.includes('Tee') && !fittingName.includes('Female')) unitCost = teeCost;
        else if (fittingName.includes('Coupling')) unitCost = couplingCost;
        else if (fittingName.includes('Female Tee')) unitCost = femTeeCost;
        else if (fittingName.includes('Male Adapter')) unitCost = maleAdapterCost;
        else if (fittingName.includes('Stop Valve')) unitCost = stopValveCost;
        
        totalFittingCost += qty * unitCost;
    }

    // Insulation cost
    const insulationCostTotal = waterSystemResults.totalInsulation * insulationCost;

    const totalMaterialCost = totalPipeMaterialCost + totalFittingCost + insulationCostTotal;
    const materialCostWithWaste = totalMaterialCost * (1 + wasteFactor);

    // Labor calculation
    const totalPipeLength = Object.values(waterSystemResults.pipeResults).reduce((sum, pipe) => sum + pipe.withWaste, 0);
    const totalFittings = Object.values(waterSystemResults.fittings).reduce((sum, qty) => sum + qty, 0);
    
    const pipeHours = totalPipeLength / productivityPipe * dailyHours;
    const fittingHours = totalFittings / productivityFitting * dailyHours;
    const totalLaborHours = pipeHours + fittingHours;

    const plumberHours = totalLaborHours * (numPlumbers / (numPlumbers + numHelpers));
    const helperHours = totalLaborHours * (numHelpers / (numPlumbers + numHelpers));
    
    const plumberCost = plumberHours * plumberRate;
    const helperCost = helperHours * helperRate;
    const totalLaborCost = plumberCost + helperCost;

    // Total cost calculation
    const subtotal = materialCostWithWaste + totalLaborCost;
    const costWithOverhead = subtotal * (1 + overhead);
    const totalCost = costWithOverhead * (1 + profitMargin);

    costResults = {
        totalPipeMaterialCost,
        totalFittingCost,
        insulationCostTotal,
        totalMaterialCost,
        materialCostWithWaste,
        totalLaborCost,
        plumberCost,
        helperCost,
        plumberHours,
        helperHours,
        totalLaborHours,
        totalCost,
        subtotal,
        costWithOverhead
    };

    laborResults = {
        totalLaborHours,
        plumberHours,
        helperHours,
        totalLaborCost,
        numPlumbers,
        numHelpers
    };

    // Display cost results
    displayCostResults();
}

function displayCostResults() {
    const output = document.getElementById('costsOutput');
    let html = '<h3>Cost & Labor Results</h3>';
    
    html += `<p><strong>Total Material Cost:</strong> ${formatCurrency(costResults.totalMaterialCost)}</p>`;
    html += `<p><strong>Material Cost with Waste:</strong> ${formatCurrency(costResults.materialCostWithWaste)}</p>`;
    html += `<p><strong>Total Labor Cost:</strong> ${formatCurrency(costResults.totalLaborCost)}</p>`;
    html += `<p><strong>Total Project Cost:</strong> ${formatCurrency(costResults.totalCost)}</p>`;
    
    html += '<h4>Labor Breakdown</h4>';
    html += `<p><strong>Total Labor Hours:</strong> ${formatNumber(costResults.totalLaborHours, 1)} hours</p>`;
    html += `<p><strong>Plumber Hours:</strong> ${formatNumber(costResults.plumberHours, 1)} hours (${laborResults.numPlumbers} plumbers)</p>`;
    html += `<p><strong>Helper Hours:</strong> ${formatNumber(costResults.helperHours, 1)} hours (${laborResults.numHelpers} helpers)</p>`;
    
    html += '<h4>Material Breakdown</h4>';
    html += `<p><strong>Pipe Materials:</strong> ${formatCurrency(costResults.totalPipeMaterialCost)}</p>`;
    html += `<p><strong>Fittings:</strong> ${formatCurrency(costResults.totalFittingCost)}</p>`;
    html += `<p><strong>Insulation:</strong> ${formatCurrency(costResults.insulationCostTotal)}</p>`;

    output.innerHTML = html;
    output.style.display = 'block';
}

// Summary and Export functions
function generateSummary() {
    if (!waterSystemResults || !costResults) {
        alert('Please calculate both water system and costs first.');
        return;
    }

    // Show all summary cards
    document.getElementById('projectSummaryCard').style.display = 'block';
    document.getElementById('waterSystemSummaryCard').style.display = 'block';
    document.getElementById('costBreakdownCard').style.display = 'block';
    document.getElementById('laborSummaryCard').style.display = 'block';

    // Project Summary
    document.getElementById('projectSummary').innerHTML = `
        <p><strong>Project Name:</strong> ${document.getElementById('projectName').value}</p>
        <p><strong>Client:</strong> ${document.getElementById('clientName').value}</p>
        <p><strong>Location:</strong> ${document.getElementById('projectLocation').value}</p>
        <p><strong>Prepared By:</strong> ${document.getElementById('preparedBy').value}</p>
        <p><strong>Currency:</strong> ${document.getElementById('currency').value}</p>
    `;

    // Water System Summary
    let waterSystemHTML = '';
    for (const key in waterSystemResults.pipeResults) {
        const pipe = waterSystemResults.pipeResults[key];
        waterSystemHTML += `<p><strong>${pipe.system} ${pipe.pipeType}:</strong> ${pipe.sticks} sticks, ${formatNumber(pipe.withWaste, 1)} m total</p>`;
    }
    waterSystemHTML += `<p><strong>Total Fixtures:</strong> ${waterSystemResults.totalFixtures}</p>`;
    waterSystemHTML += `<p><strong>Hot Water Insulation:</strong> ${formatNumber(waterSystemResults.totalInsulation, 1)} m</p>`;
    document.getElementById('waterSystemSummary').innerHTML = waterSystemHTML;

    // Cost Breakdown
    const tbody = document.querySelector('#costBreakdownTable tbody');
    tbody.innerHTML = '';
    
    function addCostRow(item, qty, unit, unitCost, totalCost) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item}</td>
            <td>${qty}</td>
            <td>${unitCost}</td>
            <td>${formatCurrency(totalCost)}</td>
        `;
        tbody.appendChild(tr);
    }

    // Add cost rows
    for (const key in waterSystemResults.pipeResults) {
        const pipe = waterSystemResults.pipeResults[key];
        const pipeCost = Array.from(document.getElementById('waterPipesContainer').getElementsByClassName('pipe-cost-row'))
            .find(row => row.querySelector('select:nth-child(2)').value === pipe.pipeType);
        const unitCost = pipeCost ? safeNumber(pipeCost.querySelector('.cost-input').value, 0) : 0;
        addCostRow(`${pipe.system} ${pipe.pipeType} Pipes`, pipe.sticks, 'sticks', formatCurrency(unitCost), pipe.sticks * unitCost);
    }

    for (const [fitting, qty] of Object.entries(waterSystemResults.fittings)) {
        let unitCost = 0;
        if (fitting.includes('Elbow')) unitCost = safeNumber(document.getElementById('elbowCost').value, 50);
        else if (fitting.includes('Tee') && !fitting.includes('Female')) unitCost = safeNumber(document.getElementById('teeCost').value, 60);
        else if (fitting.includes('Coupling')) unitCost = safeNumber(document.getElementById('couplingCost').value, 40);
        else if (fitting.includes('Female Tee')) unitCost = safeNumber(document.getElementById('femTeeCost').value, 80);
        else if (fitting.includes('Male Adapter')) unitCost = safeNumber(document.getElementById('maleAdapterCost').value, 45);
        else if (fitting.includes('Stop Valve')) unitCost = safeNumber(document.getElementById('stopValveCost').value, 120);
        
        addCostRow(fitting, qty, 'pcs', formatCurrency(unitCost), qty * unitCost);
    }

    addCostRow('Pipe Insulation', formatNumber(waterSystemResults.totalInsulation, 1), 'm', 
               formatCurrency(safeNumber(document.getElementById('insulationCost').value, 25)), 
               costResults.insulationCostTotal);

    addCostRow('Subtotal - Materials', '', '', '', costResults.totalMaterialCost);
    addCostRow('Waste Factor', '', '', document.getElementById('wasteFactor').value + '%', 
               costResults.materialCostWithWaste - costResults.totalMaterialCost);
    addCostRow('Labor Cost', '', '', '', costResults.totalLaborCost);
    addCostRow('Overhead', '', '', document.getElementById('overhead').value + '%', 
               costResults.costWithOverhead - costResults.subtotal);
    addCostRow('Profit Margin', '', '', document.getElementById('profitMargin').value + '%', 
               costResults.totalCost - costResults.costWithOverhead);
    addCostRow('TOTAL PROJECT COST', '', '', '', costResults.totalCost);

    // Labor Summary
    document.getElementById('laborSummary').innerHTML = `
        <p><strong>Total Labor Hours:</strong> ${formatNumber(laborResults.totalLaborHours, 1)} hours</p>
        <p><strong>Plumber Hours:</strong> ${formatNumber(laborResults.plumberHours, 1)} hours (${laborResults.numPlumbers} plumbers)</p>
        <p><strong>Helper Hours:</strong> ${formatNumber(laborResults.helperHours, 1)} hours (${laborResults.numHelpers} helpers)</p>
        <p><strong>Total Labor Cost:</strong> ${formatCurrency(laborResults.totalLaborCost)}</p>
        <p><strong>Productivity Rates:</strong></p>
        <ul>
            <li>Pipe installation: ${document.getElementById('productivityPipe').value} ${document.getElementById('productivityPipeUnit').textContent}</li>
            <li>Fitting installation: ${document.getElementById('productivityFitting').value} pcs/day</li>
        </ul>
    `;
}

function exportToPDF() {
    if (!waterSystemResults || !costResults) {
        alert('Please calculate both water system and costs first.');
        return;
    }

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        
        // Track page numbers manually
        let currentPage = 1;
        
        // Function to add page number to current page
        function addPageNumber() {
            const pageSize = doc.internal.pageSize;
            doc.setFont('helvetica');
            doc.setFontSize(9);
            doc.setTextColor(120);
            doc.text(`Page ${currentPage}`, pageSize.width - 60, pageSize.height - 30);
        }

        // Set consistent font family for entire document
        doc.setFont('helvetica');
        doc.setFontSize(10);

        const leftMargin = 40;
        const topMargin = 40;
        const bottomLimit = doc.internal.pageSize.getHeight() - 60;
        let y = topMargin;

        function newPageIfNeeded(linesNeeded = 60) {
            if (y + linesNeeded > bottomLimit) {
                addPageNumber();
                doc.addPage();
                currentPage++;
                y = topMargin;
                doc.setFont('helvetica');
                doc.setFontSize(10);
            }
        }

        // Title
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text("Hot & Cold Water Distribution Report", leftMargin, y);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        y += 18;

        // Project Info
        const projectName = document.getElementById('projectName').value || '';
        const clientName = document.getElementById('clientName').value || '';
        const projectLocation = document.getElementById('projectLocation').value || '';
        const preparedBy = document.getElementById('preparedBy').value || '';
        const dateStr = new Date().toLocaleDateString();

        doc.text(`Project: ${projectName}`, leftMargin, y);
        doc.text(`Client: ${clientName}`, 380, y);
        y += 14;
        doc.text(`Location: ${projectLocation}`, leftMargin, y);
        doc.text(`Date: ${dateStr}`, 380, y);
        y += 14;
        doc.text(`Prepared by: ${preparedBy}`, leftMargin, y);
        y += 20;

        // Bill of Quantities Title
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text("Bill of Quantities", leftMargin, y);
        doc.setFont('helvetica', 'normal');
        y += 8;

        // Prepare BOQ data
        const boqData = [
            ["Description", "Quantity", "Unit", "Unit Rate", "Amount"]
        ];

        // Add pipe materials
        boqData.push(["Pipes", "", "", "", ""]);
        for (const key in waterSystemResults.pipeResults) {
            const pipe = waterSystemResults.pipeResults[key];
            const pipeCost = Array.from(document.getElementById('waterPipesContainer').getElementsByClassName('pipe-cost-row'))
                .find(row => row.querySelector('select:nth-child(2)').value === pipe.pipeType);
            const unitCost = pipeCost ? safeNumber(pipeCost.querySelector('.cost-input').value, 0) : 0;
            
            boqData.push([
                `${pipe.system} ${pipe.pipeType} Pipes`,
                pipe.sticks.toString(),
                "sticks",
                formatCurrencyForPDF(unitCost),
                formatCurrencyForPDF(pipe.sticks * unitCost)
            ]);
        }

        // Add fittings
        boqData.push(["Fittings & Connectors", "", "", "", ""]);
        for (const [fitting, qty] of Object.entries(waterSystemResults.fittings)) {
            let unitCost = 0;
            if (fitting.includes('Elbow')) unitCost = safeNumber(document.getElementById('elbowCost').value, 50);
            else if (fitting.includes('Tee') && !fitting.includes('Female')) unitCost = safeNumber(document.getElementById('teeCost').value, 60);
            else if (fitting.includes('Coupling')) unitCost = safeNumber(document.getElementById('couplingCost').value, 40);
            else if (fitting.includes('Female Tee')) unitCost = safeNumber(document.getElementById('femTeeCost').value, 80);
            else if (fitting.includes('Male Adapter')) unitCost = safeNumber(document.getElementById('maleAdapterCost').value, 45);
            else if (fitting.includes('Stop Valve')) unitCost = safeNumber(document.getElementById('stopValveCost').value, 120);
            
            boqData.push([
                fitting,
                qty.toString(),
                "pcs",
                formatCurrencyForPDF(unitCost),
                formatCurrencyForPDF(qty * unitCost)
            ]);
        }

        // Add insulation
        boqData.push(["Support & Insulation", "", "", "", ""]);
        const insulationUnitCost = safeNumber(document.getElementById('insulationCost').value, 25);
        boqData.push([
            "Pipe Insulation (HWL)",
            formatNumber(waterSystemResults.totalInsulation, 1),
            "m",
            formatCurrencyForPDF(insulationUnitCost),
            formatCurrencyForPDF(waterSystemResults.totalInsulation * insulationUnitCost)
        ]);

        // Add summary rows
        const wasteFactor = safeNumber(document.getElementById('wasteFactor').value, 5);
        const overhead = safeNumber(document.getElementById('overhead').value, 15);
        const profit = safeNumber(document.getElementById('profitMargin').value, 10);

        boqData.push(["Summary", "", "", "", ""]);
        boqData.push(["Materials Subtotal", "", "", "", formatCurrencyForPDF(costResults.totalMaterialCost)]);
        boqData.push([`Waste (${wasteFactor}%)`, "", "", "", formatCurrencyForPDF(costResults.materialCostWithWaste - costResults.totalMaterialCost)]);
        boqData.push(["Materials Total", "", "", "", formatCurrencyForPDF(costResults.materialCostWithWaste)]);
        boqData.push(["Labor", "", "", "", ""]);
        boqData.push(["Plumber", formatNumber(costResults.plumberHours, 1), "hours", formatCurrencyForPDF(safeNumber(document.getElementById('plumberRate').value, 80)), formatCurrencyForPDF(costResults.plumberCost)]);
        boqData.push(["Helper", formatNumber(costResults.helperHours, 1), "hours", formatCurrencyForPDF(safeNumber(document.getElementById('helperRate').value, 50)), formatCurrencyForPDF(costResults.helperCost)]);
        boqData.push(["Labor Total", "", "", "", formatCurrencyForPDF(costResults.totalLaborCost)]);
        boqData.push(["Materials + Labor", "", "", "", formatCurrencyForPDF(costResults.subtotal)]);
        boqData.push([`Overhead (${overhead}%)`, "", "", "", formatCurrencyForPDF(costResults.costWithOverhead - costResults.subtotal)]);
        boqData.push([`Profit Margin (${profit}%)`, "", "", "", formatCurrencyForPDF(costResults.totalCost - costResults.costWithOverhead)]);
        boqData.push(["TOTAL PROJECT COST", "", "", "", formatCurrencyForPDF(costResults.totalCost)]);

        // BOQ table
        doc.autoTable({
            startY: y,
            head: [boqData[0]],
            body: boqData.slice(1),
            theme: 'grid',
            styles: { 
                font: 'helvetica', 
                fontSize: 10, 
                cellPadding: 6, 
                overflow: 'linebreak',
                fontStyle: 'normal'
            },
            headStyles: { 
                fillColor: [230,230,230], 
                textColor: 0, 
                halign: 'center', 
                fontStyle: 'bold',
                font: 'helvetica'
            },
            bodyStyles: {
                font: 'helvetica',
                fontStyle: 'normal'
            },
            columnStyles: {
                0: { cellWidth: 200, halign: 'left', font: 'helvetica' },
                1: { cellWidth: 60, halign: 'center', font: 'helvetica' },
                2: { cellWidth: 60, halign: 'center', font: 'helvetica' },
                3: { cellWidth: 100, halign: 'right', font: 'helvetica' },
                4: { cellWidth: 100, halign: 'right', font: 'helvetica' }
            },
            didParseCell: function(data) {
                const txt = (data.cell.raw||'').toString();
                if(txt === 'Pipes' || txt === 'Fittings & Connectors' || txt === 'Support & Insulation' || txt === 'Labor' || txt === 'Summary'){
                    data.cell.colSpan = 5;
                    data.cell.styles.halign = 'left';
                    data.cell.styles.fontStyle = 'bold';
                    data.cell.styles.fillColor = [240,240,240];
                    data.cell.styles.font = 'helvetica';
                }
                if(txt.includes("TOTAL PROJECT COST")){
                    data.cell.styles.fontStyle = 'bold';
                    data.cell.styles.fillColor = [200,200,200];
                    data.cell.styles.font = 'helvetica';
                }
            },
            didDrawPage: function(data) {
                currentPage = data.pageNumber;
                addPageNumber();
            }
        });

        // Position after table
        y = doc.autoTable.previous.finalY + 25;
        doc.setFont('helvetica');
        doc.setFontSize(10);

        // Function to create summary sections without boxes
        function createSummarySection(title, contentLines) {
            newPageIfNeeded((contentLines.length + 2) * 14);
            
            // Section title
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text(title, leftMargin, y);
            y += 16;
            
            // Section content
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            contentLines.forEach(line => {
                // Check if we need a new page for each line
                if (y > bottomLimit - 20) {
                    addPageNumber();
                    doc.addPage();
                    currentPage++;
                    y = topMargin;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                }
                doc.text(line, leftMargin, y);
                y += 14;
            });
            
            y += 12; // Add extra spacing after section
        }

        // WATER SYSTEM SUMMARY
        const waterSystemContent = [];
        for (const key in waterSystemResults.pipeResults) {
            const pipe = waterSystemResults.pipeResults[key];
            waterSystemContent.push(`${pipe.system} ${pipe.pipeType}: ${pipe.sticks} sticks, ${formatNumber(pipe.withWaste, 1)} m total`);
        }
        waterSystemContent.push(`Total Fixtures: ${waterSystemResults.totalFixtures}`);
        waterSystemContent.push(`Hot Water Insulation: ${formatNumber(waterSystemResults.totalInsulation, 1)} m`);
        waterSystemContent.push(`Calculation Mode: ${waterSystemResults.settings.mode === 'auto' ? 'Auto' : 'Manual'}`);
        
        createSummarySection('Water System Summary', waterSystemContent);

        // FIXTURES SUMMARY
        const fixturesContent = [];
        for (const [name, qty] of Object.entries(waterSystemResults.fixtures)) {
            if (qty > 0) {
                const displayName = name.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                fixturesContent.push(`${displayName}: ${qty}`);
            }
        }
        if (fixturesContent.length === 0) {
            fixturesContent.push('No fixtures specified');
        }
        
        createSummarySection('Fixture Summary', fixturesContent);

        // LABOR SUMMARY
        const laborContent = [
            `Total Labor Hours: ${formatNumber(costResults.totalLaborHours, 1)} hrs`,
            `Plumber Hours: ${formatNumber(costResults.plumberHours, 1)} hrs (${laborResults.numPlumbers} plumbers)`,
            `Helper Hours: ${formatNumber(costResults.helperHours, 1)} hrs (${laborResults.numHelpers} helpers)`,
            `Total Labor Cost: ${formatCurrencyForPDF(costResults.totalLaborCost)}`,
            `Productivity rates used:`,
            `  • Pipe installation: ${document.getElementById('productivityPipe').value} ${document.getElementById('productivityPipeUnit').textContent}`,
            `  • Fitting installation: ${document.getElementById('productivityFitting').value} pcs/day`
        ];
        
        createSummarySection('Labor Requirements', laborContent);

        // Add page number to the final page
        addPageNumber();

        // Save file
        const safeName = (document.getElementById('projectName').value||'project').replace(/[^a-z0-9]/gi,'_');
        doc.save(`${safeName}_water_system_report.pdf`);
        
    } catch (err) {
        console.error(err);
        alert('Error generating PDF: ' + err.message);
    }
}

function exportToExcel() {
    if (!waterSystemResults || !costResults) {
        alert('Please calculate both water system and costs first.');
        return;
    }

    try {
        const wb = XLSX.utils.book_new();
        
        // Project Summary Sheet
        const projectData = [
            ['Hot & Cold Water Distribution Report'],
            [],
            ['Project Information'],
            ['Project Name', document.getElementById('projectName').value],
            ['Client', document.getElementById('clientName').value],
            ['Location', document.getElementById('projectLocation').value],
            ['Prepared By', document.getElementById('preparedBy').value],
            ['Date', new Date().toLocaleDateString()],
            [],
            ['Water System Summary']
        ];
        
        for (const key in waterSystemResults.pipeResults) {
            const pipe = waterSystemResults.pipeResults[key];
            projectData.push([`${pipe.system} ${pipe.pipeType}`, `${pipe.sticks} sticks, ${pipe.withWaste.toFixed(1)} m`]);
        }
        
        projectData.push(['Total Fixtures', waterSystemResults.totalFixtures]);
        projectData.push(['Hot Water Insulation', `${waterSystemResults.totalInsulation.toFixed(1)} m`]);
        
        const ws1 = XLSX.utils.aoa_to_sheet(projectData);
        XLSX.utils.book_append_sheet(wb, ws1, 'Project Summary');
        
        // Cost Breakdown Sheet
        const costData = [['Item', 'Quantity', 'Unit Cost', 'Total Cost']];
        
        for (const key in waterSystemResults.pipeResults) {
            const pipe = waterSystemResults.pipeResults[key];
            const pipeCost = Array.from(document.getElementById('waterPipesContainer').getElementsByClassName('pipe-cost-row'))
                .find(row => row.querySelector('select:nth-child(2)').value === pipe.pipeType);
            const unitCost = pipeCost ? safeNumber(pipeCost.querySelector('.cost-input').value, 0) : 0;
            costData.push([
                `${pipe.system} ${pipe.pipeType} Pipes`,
                `${pipe.sticks} sticks`,
                unitCost,
                pipe.sticks * unitCost
            ]);
        }
        
        costData.push(['TOTAL PROJECT COST', '', '', costResults.totalCost]);
        
        const ws2 = XLSX.utils.aoa_to_sheet(costData);
        XLSX.utils.book_append_sheet(wb, ws2, 'Cost Breakdown');
        
        // Save Excel file
        const safeName = document.getElementById('projectName').value.replace(/[^a-z0-9]/gi, '_');
        XLSX.writeFile(wb, `${safeName}_water_system_report.xlsx`);
        
    } catch (err) {
        console.error(err);
        alert('Error generating Excel file: ' + err.message);
    }
}

// Project save/load functions
function saveProjectAsJSON() {
    const data = {
        projectName: document.getElementById('projectName').value,
        clientName: document.getElementById('clientName').value,
        projectLocation: document.getElementById('projectLocation').value,
        preparedBy: document.getElementById('preparedBy').value,
        currency: document.getElementById('currency').value,
        codeStandard: document.getElementById('codeStandard').value,
        units: document.getElementById('units').value,
        waterSystemResults: waterSystemResults,
        costResults: costResults
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${document.getElementById('projectName').value.replace(/[^a-z0-9]/gi, '_')}_water_project.json`;
    a.click();
}

function loadProjectFromJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // Load basic project info
            if (data.projectName) document.getElementById('projectName').value = data.projectName;
            if (data.clientName) document.getElementById('clientName').value = data.clientName;
            if (data.projectLocation) document.getElementById('projectLocation').value = data.projectLocation;
            if (data.preparedBy) document.getElementById('preparedBy').value = data.preparedBy;
            if (data.currency) document.getElementById('currency').value = data.currency;
            if (data.codeStandard) document.getElementById('codeStandard').value = data.codeStandard;
            if (data.units) document.getElementById('units').value = data.units;
            
            // Load results if they exist
            if (data.waterSystemResults) waterSystemResults = data.waterSystemResults;
            if (data.costResults) costResults = data.costResults;
            
            alert('Project loaded successfully! You can now view the summary or recalculate costs.');
            
        } catch (err) {
            alert('Error loading project: ' + err.message);
        }
    };
    reader.readAsText(file);
}

function resetCalculator() {
    if (!confirm('Reset calculator to defaults?')) return;
    location.reload();
}
</script>
</body>
</html>
