<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sanitary & Storm Drain Calculator</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body {
    font-family: Helvetica, Arial, sans-serif;
    background: #f8f9fa;
    color: #212529;
  }
  h1,h2,h3,h4 { font-weight: 600; }
  .tab-content { background: #fff; padding: 1rem 1.5rem; border: 1px solid #dee2e6; border-top: none; }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(250px,1fr));
    gap: 1rem;
  }
  .disclaimer {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #000; /* black text as requested */
    font-size: 0.9rem;
    padding: 0.75rem;
    border-radius: 0.25rem;
  }
  input.error { border-color: #dc3545 !important; }
  @media (max-width:768px){
    .nav-tabs { flex-wrap: wrap; }
    .tab-content { padding: 1rem; }
  }
</style>
</head>

<body class="container py-4">

  <h1 class="mb-3 text-center">Sanitary &amp; Storm Drain Calculator</h1>

  <!-- Unit Toggle -->
  <div class="d-flex justify-content-end mb-3">
    <label for="unitSystem" class="me-2 fw-semibold">Units:</label>
    <select id="unitSystem" class="form-select w-auto">
      <option value="metric" selected>Metric (m, mm, L/s)</option>
      <option value="imperial">Imperial (ft, in, gpm)</option>
    </select>
  </div>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs" id="calcTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" id="sanitary-tab" data-bs-toggle="tab" data-bs-target="#sanitary" role="tab">Sanitary System</button></li>
    <li class="nav-item"><button class="nav-link" id="storm-tab" data-bs-toggle="tab" data-bs-target="#storm" role="tab">Storm Drain</button></li>
    <li class="nav-item"><button class="nav-link" id="labor-tab" data-bs-toggle="tab" data-bs-target="#labor" role="tab">Labor &amp; Productivity</button></li>
    <li class="nav-item"><button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" role="tab">Report / Output</button></li>
  </ul>

  <div class="tab-content" id="calcTabsContent">

    <!-- ========== SANITARY SYSTEM TAB ========== -->
    <div class="tab-pane fade show active" id="sanitary" role="tabpanel">
      <h3>Sanitary System</h3>
      <div class="form-grid">
        <div>
          <label class="form-label" for="sanPipeLength">Pipe Length</label>
          <input type="number" id="sanPipeLength" class="form-control" aria-label="Sanitary pipe length" min="0" value="0">
        </div>
        <div>
          <label class="form-label" for="sanPipeSize">Pipe Size (<span class="unit-length">mm</span>)</label>
          <input type="number" id="sanPipeSize" class="form-control" aria-label="Sanitary pipe size" min="50" value="100">
        </div>
        <div>
          <label class="form-label" for="sanSlope">Slope (%)</label>
          <input type="number" id="sanSlope" class="form-control" aria-label="Sanitary slope" min="0.1" value="1">
        </div>
        <div>
          <label class="form-label" for="sanMHCount">No. of Manholes</label>
          <input type="number" id="sanMHCount" class="form-control" aria-label="Sanitary manhole count" min="0" value="0">
        </div>
      </div>
    </div>

    <!-- ========== STORM DRAIN TAB ========== -->
    <div class="tab-pane fade" id="storm" role="tabpanel">
      <h3>Storm Drain System</h3>
      <div class="form-grid">
        <div>
          <label class="form-label" for="catchmentArea">Catchment Area (<span class="unit-area">m²</span>)</label>
          <input type="number" id="catchmentArea" class="form-control" aria-label="Catchment area" min="0" value="0">
        </div>
        <div>
          <label class="form-label" for="rainIntensity">Rainfall Intensity (<span class="unit-rain">mm/hr</span>)</label>
          <input type="number" id="rainIntensity" class="form-control" aria-label="Rainfall intensity" min="0" value="0">
        </div>
        <div>
          <label class="form-label" for="runoffCoeff">Runoff Coefficient (C)</label>
          <input type="number" id="runoffCoeff" class="form-control" aria-label="Runoff coefficient" min="0" max="1" step="0.05" value="0.8">
        </div>
        <div>
          <label class="form-label" for="stormPipeSize">Pipe Size (<span class="unit-length">mm</span>)</label>
          <input type="number" id="stormPipeSize" class="form-control" aria-label="Storm pipe size" min="50" value="150">
        </div>
      </div>
    </div>

    <!-- ========== LABOR & PRODUCTIVITY TAB ========== -->
    <div class="tab-pane fade" id="labor" role="tabpanel">
      <h3>Labor &amp; Productivity</h3>
      <div class="form-grid">
        <div>
          <label class="form-label" for="numPlumbers">Plumbers</label>
          <input type="number" id="numPlumbers" class="form-control" min="0" value="2">
        </div>
        <div>
          <label class="form-label" for="numHelpers">Helpers</label>
          <input type="number" id="numHelpers" class="form-control" min="0" value="2">
        </div>
        <div>
          <label class="form-label" for="prodPipeLaying">Pipe Laying Productivity (<span class="unit-prod">m/day</span>)</label>
          <input type="number" id="prodPipeLaying" class="form-control" min="0.1" value="10">
        </div>
        <div>
          <label class="form-label" for="prodManhole">Manhole Installation Productivity (units/day)</label>
          <input type="number" id="prodManhole" class="form-control" min="0.1" value="0.8">
        </div>
      </div>
    </div>

    <!-- ========== REPORT TAB ========== -->
    <div class="tab-pane fade" id="report" role="tabpanel">
      <h3>Report / Output</h3>
      <div class="mb-3">
        <button class="btn btn-primary me-2" id="generateReportBtn">Generate Report (PDF)</button>
        <button class="btn btn-outline-success me-2" id="saveJSONBtn">Save Project (JSON)</button>
        <label class="btn btn-outline-secondary mb-0">
          Load Project (JSON)
          <input type="file" id="loadJSONInput" accept=".json" hidden>
        </label>
      </div>
      <div id="outputArea" class="border rounded p-3 bg-light small"></div>
    </div>
  </div>

  <p class="disclaimer mt-4">
    Note: This calculator uses practical approximations. For formal design consult local codes and a licensed engineer.
  </p>

<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* -----------------------
  Part 2 - JavaScript Core
  - Validation
  - Unit conversion & labels
  - Lazy calculations (caching & dirty flags)
  - Save/Load JSON
  - Keyboard navigation for tabs
-------------------------*/

/* --- Helpers & Constants --- */
const MM_PER_IN = 25.4;
const M_TO_FT = 3.28084;
const M2_TO_FT2 = 10.76391041671;
const LS_TO_GPM = 15.85032314;
const IN_TO_MM = 25.4; // same as MM_PER_IN

const qs = (s, el = document) => el.querySelector(s);
const qsa = (s, el = document) => Array.from(el.querySelectorAll(s));

function clampMin(value, min=0){
  if (isNaN(value)) return min;
  return Math.max(min, value);
}
function round(v, dp=3){ return Math.round((v+Number.EPSILON)*Math.pow(10, dp))/Math.pow(10, dp); }
function fmt(n, dp=2){ if (n===null || n===undefined || isNaN(n)) return ''; return round(n, dp).toLocaleString(); }

/* --- DOM references (broad) --- */
const unitSystemEl = document.getElementById('unitSystem');
const outputArea = document.getElementById('outputArea');

/* Inputs (sanitary) */
const sanPipeLengthEl = document.getElementById('sanPipeLength');
const sanPipeSizeEl = document.getElementById('sanPipeSize');
const sanSlopeEl = document.getElementById('sanSlope');
const sanMHCountEl = document.getElementById('sanMHCount');

/* Inputs (storm) */
const catchmentAreaEl = document.getElementById('catchmentArea');
const rainIntensityEl = document.getElementById('rainIntensity');
const runoffCoeffEl = document.getElementById('runoffCoeff');
const stormPipeSizeEl = document.getElementById('stormPipeSize');

/* Inputs (labor) */
const numPlumbersEl = document.getElementById('numPlumbers');
const numHelpersEl = document.getElementById('numHelpers');
const prodPipeLayingEl = document.getElementById('prodPipeLaying');
const prodManholeEl = document.getElementById('prodManhole');

/* Controls */
const generateReportBtn = document.getElementById('generateReportBtn');
const saveJSONBtn = document.getElementById('saveJSONBtn');
const loadJSONInput = document.getElementById('loadJSONInput');

/* Unit label spans */
const unitLengthSpans = qsa('.unit-length');
const unitAreaSpans = qsa('.unit-area');
const unitRainSpans = qsa('.unit-rain');
const unitProdSpans = qsa('.unit-prod');

/* --- Validation & Error UI --- */
function setError(inputEl, msg){
  inputEl.classList.add('error');
  inputEl.setAttribute('aria-invalid','true');
  if(msg){
    inputEl.title = msg;
  }
}
function clearError(inputEl){
  inputEl.classList.remove('error');
  inputEl.removeAttribute('aria-invalid');
  inputEl.title = '';
}
function validateNonNegative(inputEl){
  const v = parseFloat(inputEl.value);
  if(isNaN(v) || v < 0){
    setError(inputEl, 'Value must be zero or positive.');
    return false;
  }
  clearError(inputEl);
  return true;
}
/* Validate all numeric inputs that matter */
function validateAll(){
  const inputs = [sanPipeLengthEl, sanPipeSizeEl, sanSlopeEl, sanMHCountEl,
    catchmentAreaEl, rainIntensityEl, runoffCoeffEl, stormPipeSizeEl,
    numPlumbersEl, numHelpersEl, prodPipeLayingEl, prodManholeEl];
  let ok = true;
  inputs.forEach(inp=>{
    if(!validateNonNegative(inp)) ok = false;
  });
  // runoffCoeff should be between 0 and 1
  const c = parseFloat(runoffCoeffEl.value);
  if(isNaN(c) || c < 0 || c > 1){
    setError(runoffCoeffEl, 'Runoff coefficient must be between 0 and 1.');
    ok = false;
  } else {
    clearError(runoffCoeffEl);
  }
  return ok;
}

/* --- Unit system handling & conversions --- */
let lastUnitSystem = unitSystemEl.value || 'metric';

function updateUnitLabels(){
  const units = unitSystemEl.value;
  const lengthLabel = units === 'metric' ? 'm' : 'ft';
  const areaLabel = units === 'metric' ? 'm²' : 'ft²';
  const rainLabel = units === 'metric' ? 'mm/hr' : 'in/hr';
  const prodLabel = units === 'metric' ? 'm/day' : 'ft/day';
  unitLengthSpans.forEach(s=>s.textContent = units === 'metric' ? 'mm' : 'in'); // pipe size label is mm/in
  unitAreaSpans.forEach(s=>s.textContent = areaLabel);
  unitRainSpans.forEach(s=>s.textContent = rainLabel);
  unitProdSpans.forEach(s=>s.textContent = prodLabel);
  // also adjust textual unit spans inside form labels where needed
}

/* Convert visible numeric inputs from one unit system to another (metric <-> imperial)
   Keep internal calculations in metric base where necessary.
*/
function convertVisibleValues(fromUnits, toUnits){
  if(fromUnits === toUnits) return;
  // lengths: sanPipeLength (m <-> ft)
  if(fromUnits === 'metric' && toUnits === 'imperial'){
    sanPipeLengthEl.value = round((parseFloat(sanPipeLengthEl.value||0) * M_TO_FT), 3);
    catchmentAreaEl.value = round((parseFloat(catchmentAreaEl.value||0) * M2_TO_FT2), 3);
    rainIntensityEl.value = round((parseFloat(rainIntensityEl.value||0) * (1/25.4)), 3); // mm/hr -> in/hr
    // productivities: m/day -> ft/day
    prodPipeLayingEl.value = round((parseFloat(prodPipeLayingEl.value||0) * M_TO_FT), 3);
    // pipe sizes: mm -> in (display as inches)
    sanPipeSizeEl.value = round((parseFloat(sanPipeSizeEl.value||0) / MM_PER_IN), 2);
    stormPipeSizeEl.value = round((parseFloat(stormPipeSizeEl.value||0) / MM_PER_IN), 2);
  } else if(fromUnits === 'imperial' && toUnits === 'metric'){
    sanPipeLengthEl.value = round((parseFloat(sanPipeLengthEl.value||0) / M_TO_FT), 3);
    catchmentAreaEl.value = round((parseFloat(catchmentAreaEl.value||0) / M2_TO_FT2), 3);
    rainIntensityEl.value = round((parseFloat(rainIntensityEl.value||0) * 25.4), 3); // in/hr -> mm/hr
    // productivities: ft/day -> m/day
    prodPipeLayingEl.value = round((parseFloat(prodPipeLayingEl.value||0) / M_TO_FT), 3);
    // pipe sizes: in -> mm
    sanPipeSizeEl.value = round((parseFloat(sanPipeSizeEl.value||0) * MM_PER_IN), 0);
    stormPipeSizeEl.value = round((parseFloat(stormPipeSizeEl.value||0) * MM_PER_IN), 0);
  }
  updateUnitLabels();
}

/* Update lastUnitSystem and perform conversion */
unitSystemEl.addEventListener('change', ()=>{
  const newUnits = unitSystemEl.value;
  convertVisibleValues(lastUnitSystem, newUnits);
  lastUnitSystem = newUnits;
  markAllDirty(); // unit change affects caches
});

/* --- Caching & Lazy Calculation --- */
let sanitaryCache = null;
let stormCache = null;
let laborCache = null;
let dirty = { sanitary: true, storm: true, labor: true };

function markDirty(section){
  dirty[section] = true;
}
function markAllDirty(){
  Object.keys(dirty).forEach(k => dirty[k] = true);
}
function clearCache(section){
  if(section === 'sanitary') sanitaryCache = null;
  if(section === 'storm') stormCache = null;
  if(section === 'labor') laborCache = null;
  dirty[section] = true;
}

/* Attach change listeners to mark dirty & validate - avoid recalculating immediately (lazy) */
const inputsToWatch = [
  sanPipeLengthEl, sanPipeSizeEl, sanSlopeEl, sanMHCountEl,
  catchmentAreaEl, rainIntensityEl, runoffCoeffEl, stormPipeSizeEl,
  numPlumbersEl, numHelpersEl, prodPipeLayingEl, prodManholeEl
];
inputsToWatch.forEach(inp=>{
  inp.addEventListener('input', ()=>{
    // basic clamp and validation
    const v = parseFloat(inp.value);
    if(!isNaN(v) && v < 0){
      setError(inp, 'Value cannot be negative.');
    } else {
      clearError(inp);
    }
    // mark appropriate section dirty
    if([sanPipeLengthEl, sanPipeSizeEl, sanSlopeEl, sanMHCountEl].includes(inp)) markDirty('sanitary');
    if([catchmentAreaEl, rainIntensityEl, runoffCoeffEl, stormPipeSizeEl].includes(inp)) markDirty('storm');
    if([numPlumbersEl, numHelpersEl, prodPipeLayingEl, prodManholeEl].includes(inp)) markDirty('labor');
  });
});

/* --- Calculation functions (metric internal) --- */

/* Sanitry calculations (internal metric)
   Returns object:
   { pipeLength_m, pipeSize_mm, manholes, fittings, totalFixtureUnits (if expanded later), ... }
*/
function calculateSanitary(force=false){
  if(!force && !dirty.sanitary && sanitaryCache) return sanitaryCache;
  // validation
  if(!validateNonNegative(sanPipeLengthEl) || !validateNonNegative(sanPipeSizeEl) || !validateNonNegative(sanMHCountEl)) {
    outputArea.innerHTML = '<div class="text-danger">Please correct highlighted inputs in Sanitary tab.</div>';
    throw new Error('Sanitary validation failed');
  }

  const units = unitSystemEl.value;
  let pipeLength_m = parseFloat(sanPipeLengthEl.value) || 0;
  let pipeSize_mm = parseFloat(sanPipeSizeEl.value) || 0;
  // if currently in imperial, displayed pipe size is in inches -> convert to mm
  if(units === 'imperial'){
    pipeSize_mm = round(pipeSize_mm * MM_PER_IN, 0);
  }

  // simple accessory heuristics
  const manholes = clampMin(Math.round(parseFloat(sanMHCountEl.value)||0), 0);
  const fittings = Math.max(1, Math.ceil((pipeLength_m || 0) / 10)); // arbitrary
  sanitaryCache = { pipeLength_m, pipeSize_mm, manholes, fittings };
  dirty.sanitary = false;
  return sanitaryCache;
}

/* Storm calculations (metric internal)
   Returns object:
   { catchmentArea_m2, runoff_Ls, pipeSize_mm, catchBasins, manholes, fittings }
*/
function calculateStorm(force=false){
  if(!force && !dirty.storm && stormCache) return stormCache;
  if(!validateNonNegative(catchmentAreaEl) || !validateNonNegative(rainIntensityEl) || !validateNonNegative(stormPipeSizeEl)) {
    outputArea.innerHTML = '<div class="text-danger">Please correct highlighted inputs in Storm tab.</div>';
    throw new Error('Storm validation failed');
  }
  const units = unitSystemEl.value;
  let area_m2 = parseFloat(catchmentAreaEl.value) || 0;
  let intensity_mm = parseFloat(rainIntensityEl.value) || 0;
  let pipeSize_mm = parseFloat(stormPipeSizeEl.value) || 0;
  if(units === 'imperial'){
    area_m2 = round((area_m2 / M2_TO_FT2), 3);
    intensity_mm = round((intensity_mm * 25.4), 3); // in/hr -> mm/hr
    pipeSize_mm = round(pipeSize_mm * MM_PER_IN, 0); // in -> mm
  }
  const C = clampMin(parseFloat(runoffCoeffEl.value) || 0.8, 0);
  // Rational method variant: Q (L/s) = C * I(mm/hr) * A(m2) / 360
  const runoff_Ls = C * intensity_mm * area_m2 / 360;
  const catchBasins = Math.ceil(area_m2 / 200); // heuristic
  const manholes = Math.ceil(area_m2 / 500); // heuristic
  const fittings = Math.max(1, Math.ceil(area_m2 / 100));
  stormCache = { catchmentArea_m2: area_m2, runoff_Ls, pipeSize_mm, catchBasins, manholes, fittings, C, intensity_mm };
  dirty.storm = false;
  return stormCache;
}

/* Labor calculations (use productivities; productivities input are in m/day when metric, ft/day if imperial)
   Returns:
   { pipeDays, manholeDays, totalDays, plumberHours, helperHours ... }
*/
function calculateLabor(force=false){
  if(!force && !dirty.labor && laborCache) return laborCache;
  if(!validateNonNegative(numPlumbersEl) || !validateNonNegative(numHelpersEl) || !validateNonNegative(prodPipeLayingEl) || !validateNonNegative(prodManholeEl)){
    outputArea.innerHTML = '<div class="text-danger">Please correct highlighted inputs in Labor tab.</div>';
    throw new Error('Labor validation failed');
  }

  // Ensure we have the latest sanitary & storm caches (lazily compute them)
  const san = calculateSanitary();
  const storm = calculateStorm();
  const units = unitSystemEl.value;

  // productivities -> convert to metric base (m/day)
  let pipeProd = parseFloat(prodPipeLayingEl.value) || 1; // in m/day or ft/day
  if(units === 'imperial') pipeProd = pipeProd / M_TO_FT; // ft/day -> m/day
  let manholeProd = parseFloat(prodManholeEl.value) || 0.8; // units/day

  const totalPipeLength_m = (san.pipeLength_m || 0);
  const pipeDays = pipeProd > 0 ? totalPipeLength_m / pipeProd : 0;
  const manholeDays = manholeProd > 0 ? (san.manholes + storm.manholes) / manholeProd : 0;
  const totalDays = pipeDays + manholeDays;
  const dailyHours = 8; // assume 8h shift; could be user configurable later
  const totalLaborHours = totalDays * dailyHours;

  const numPlumbers = Math.max(1, parseInt(numPlumbersEl.value) || 1);
  const numHelpers = Math.max(0, parseInt(numHelpersEl.value) || 0);
  const totalWorkers = numPlumbers + numHelpers;
  const plumberHours = totalLaborHours * (numPlumbers / totalWorkers);
  const helperHours = totalLaborHours * (numHelpers / totalWorkers);

  laborCache = { pipeDays, manholeDays, totalDays, totalLaborHours, plumberHours, helperHours, numPlumbers, numHelpers, dailyHours };
  dirty.labor = false;
  return laborCache;
}

/* --- Generate a compact HTML summary (for Report tab output area) --- */
function buildReportPreview(){
  try{
    // Validate everything before building
    if(!validateAll()){
      outputArea.innerHTML = '<div class="text-danger">Validation errors exist. Please correct highlighted fields.</div>';
      return;
    }

    const san = calculateSanitary();
    const storm = calculateStorm();
    const labor = calculateLabor();

    const units = unitSystemEl.value;
    const flowDisplay = units === 'metric' ? `${fmt(storm.runoff_Ls,2)} L/s` : `${fmt(storm.runoff_Ls * LS_TO_GPM,2)} gpm`;
    const sanSizeDisplay = units === 'metric' ? `${round(san.pipeSize_mm,0)} mm` : `${round(san.pipeSize_mm / MM_PER_IN,2)} in`;
    const stormSizeDisplay = units === 'metric' ? `${round(storm.pipeSize_mm,0)} mm` : `${round(storm.pipeSize_mm / MM_PER_IN,2)} in`;

    let html = `<h5>Sanitary System Summary</h5>
      <ul>
        <li>Pipe Size: <strong>${sanSizeDisplay}</strong></li>
        <li>Pipe Length: <strong>${fmt(san.pipeLength_m,2)} m</strong></li>
        <li>Manholes: <strong>${san.manholes}</strong></li>
        <li>Fittings (est.): <strong>${san.fittings}</strong></li>
      </ul>

      <h5>Storm Drain System Summary</h5>
      <ul>
        <li>Catchment Area: <strong>${fmt(storm.catchmentArea_m2,2)} m²</strong></li>
        <li>Runoff: <strong>${flowDisplay}</strong></li>
        <li>Pipe Size Selected: <strong>${stormSizeDisplay}</strong></li>
        <li>Catch Basins: <strong>${storm.catchBasins}</strong></li>
      </ul>

      <h5>Labor Requirements</h5>
      <ul>
        <li>Total labor days (est.): <strong>${fmt(labor.totalDays,2)} days</strong></li>
        <li>Total labor hours: <strong>${fmt(labor.totalLaborHours,1)} hrs</strong></li>
        <li>Plumber hours: <strong>${fmt(labor.plumberHours,1)} hrs (${labor.numPlumbers} plumbers)</strong></li>
        <li>Helper hours: <strong>${fmt(labor.helperHours,1)} hrs (${labor.numHelpers} helpers)</strong></li>
      </ul>`;

    outputArea.innerHTML = html;
  } catch(err){
    console.warn('Report preview generation failed:', err);
    if(!outputArea.innerHTML) outputArea.innerHTML = '<div class="text-danger">Unable to build preview. Fix inputs and try again.</div>';
  }
}

/* --- Save / Load JSON (file) --- */
function collectProjectData(){
  // gather all form field values (string values so JSON is simple)
  const data = {
    meta: { units: unitSystemEl.value, savedAt: new Date().toISOString() },
    sanitary: {
      pipeLength: sanPipeLengthEl.value,
      pipeSize: sanPipeSizeEl.value,
      slope: sanSlopeEl.value,
      manholes: sanMHCountEl.value
    },
    storm: {
      area: catchmentAreaEl.value,
      intensity: rainIntensityEl.value,
      runoffCoeff: runoffCoeffEl.value,
      pipeSize: stormPipeSizeEl.value
    },
    labor: {
      numPlumbers: numPlumbersEl.value,
      numHelpers: numHelpersEl.value,
      prodPipe: prodPipeLayingEl.value,
      prodManhole: prodManholeEl.value
    }
  };
  return data;
}

function saveProjectToJSONFile(){
  const data = collectProjectData();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const filename = `sanitary_storm_project_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')}.json`;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
saveJSONBtn.addEventListener('click', (e) => {
  try{
    if(!validateAll()){ outputArea.innerHTML = '<div class="text-danger">Cannot save: validation errors exist.</div>'; return; }
    saveProjectToJSONFile();
    outputArea.innerHTML = '<div class="text-success">Project JSON saved to your device.</div>';
  } catch(err){
    console.error(err); outputArea.innerHTML = '<div class="text-danger">Error saving project: ' + err.message + '</div>';
  }
});

function loadProjectFromJSONFile(file){
  const reader = new FileReader();
  reader.onload = function(ev){
    try{
      const data = JSON.parse(ev.target.result);
      // restore values (no branding expected)
      if(data.meta && data.meta.units){
        // ensure we convert displayed values correctly if units differ
        const prevUnits = unitSystemEl.value;
        const incomingUnits = data.meta.units;
        // apply values as strings first
        if(data.sanitary){
          sanPipeLengthEl.value = data.sanitary.pipeLength || 0;
          sanPipeSizeEl.value = data.sanitary.pipeSize || 0;
          sanSlopeEl.value = data.sanitary.slope || 0;
          sanMHCountEl.value = data.sanitary.manholes || 0;
        }
        if(data.storm){
          catchmentAreaEl.value = data.storm.area || 0;
          rainIntensityEl.value = data.storm.intensity || 0;
          runoffCoeffEl.value = data.storm.runoffCoeff || 0.8;
          stormPipeSizeEl.value = data.storm.pipeSize || 0;
        }
        if(data.labor){
          numPlumbersEl.value = data.labor.numPlumbers || 1;
          numHelpersEl.value = data.labor.numHelpers || 0;
          prodPipeLayingEl.value = data.labor.prodPipe || 10;
          prodManholeEl.value = data.labor.prodManhole || 0.8;
        }
        // If incoming units differ from current, ensure conversion
        if(incomingUnits !== prevUnits){
          // Temporarily set unitSystem to incoming to allow convertVisibleValues to work correctly,
          // then call convertVisibleValues to bring displayed values into current units.
          unitSystemEl.value = incomingUnits;
          // set lastUnitSystem to incoming so convert uses correct 'from' value
          lastUnitSystem = incomingUnits;
          // now convert from incomingUnits to prevUnits (user's current selection)
          convertVisibleValues(incomingUnits, prevUnits);
          // restore unit selector's visible value to prevUnits
          unitSystemEl.value = prevUnits;
          lastUnitSystem = prevUnits;
        }
      } else {
        // Basic fallback restore even if meta not present
        if(data.sanitary){
          sanPipeLengthEl.value = data.sanitary.pipeLength || sanPipeLengthEl.value;
          sanPipeSizeEl.value = data.sanitary.pipeSize || sanPipeSizeEl.value;
        }
      }
      markAllDirty();
      outputArea.innerHTML = '<div class="text-success">Project loaded from JSON. Run Generate Report to update outputs.</div>';
    } catch(err){
      console.error(err);
      outputArea.innerHTML = '<div class="text-danger">Invalid JSON file or parsing error.</div>';
    }
  };
  reader.readAsText(file);
}

loadJSONInput.addEventListener('change', (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  loadProjectFromJSONFile(f);
  // clear input so same file can be reloaded later if needed
  loadJSONInput.value = '';
});

/* --- Keyboard navigation for tabs (left/right arrows) --- */
const tabList = document.getElementById('calcTabs');
tabList.addEventListener('keydown', (e)=>{
  const active = tabList.querySelector('.nav-link.active');
  if(!active) return;
  if(e.key === 'ArrowRight' || e.key === 'ArrowLeft'){
    e.preventDefault();
    const links = Array.from(tabList.querySelectorAll('.nav-link'));
    const idx = links.indexOf(active);
    let nextIdx = idx;
    if(e.key === 'ArrowRight') nextIdx = (idx + 1) % links.length;
    if(e.key === 'ArrowLeft') nextIdx = (idx - 1 + links.length) % links.length;
    links[nextIdx].focus();
    links[nextIdx].click();
  }
});

/* --- Generate report button: build preview and then call PDF generator (Part 3) --- */
generateReportBtn.addEventListener('click', (e) => {
  try{
    // Validate inputs first
    if(!validateAll()){
      outputArea.innerHTML = '<div class="text-danger">Please fix validation errors before generating report.</div>';
      return;
    }
    // Build preview in the report tab
    buildReportPreview();
    // Call PDF generator (function implemented in Part 3) - keep it asynchronous-friendly
    if(typeof generatePDFReport === 'function'){
      // ensure caches are up-to-date
      calculateSanitary(true);
      calculateStorm(true);
      calculateLabor(true);
      // pass the cached results to the PDF generator
      generatePDFReport({ sanitary: sanitaryCache, storm: stormCache, labor: laborCache });
    } else {
      // If Part 3 not present, just show preview message
      outputArea.innerHTML += '<div class="text-muted mt-2">PDF generator not available in this part. Proceeding only with preview.</div>';
    }
  } catch(err){
    console.error('Report generation error:', err);
    outputArea.innerHTML = '<div class="text-danger">Error generating report. Check input values.</div>';
  }
});

/* --- Accessibility: ensure labels have 'for' and inputs have ARIA (added in markup) --- */
/* Extra: move focus to outputArea after generating preview for keyboard users */
generateReportBtn.addEventListener('keydown', (e) => {
  if(e.key === 'Enter' || e.key === ' '){
    e.preventDefault();
    generateReportBtn.click();
  }
});

/* Initialize unit labels and any other UI state */
updateUnitLabels();
markAllDirty();
</script>
<!-- jsPDF (for PDF generation) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ---------------------------
   Part 3 - PDF Report
   - Neutral professional layout (Helvetica, black text)
   - Sections:
       1. Header
       2. Bill of Quantities
       3. Sanitary System Summary
       4. Storm Drain System Summary
       5. Labor Requirements
   - Omits productivity & pipe length lines
----------------------------*/

const { jsPDF } = window.jspdf;

function generatePDFReport(data){
  const doc = new jsPDF({ unit: "mm", format: "a4" });
  const margin = 15;
  let y = margin;

  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  // Header
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("Sanitary & Storm Drain Report", pageWidth / 2, y, { align: "center" });
  y += 8;
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth - margin, y, { align: "right" });
  y += 6;
  doc.line(margin, y, pageWidth - margin, y);
  y += 8;

  // ===== Bill of Quantities =====
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("Bill of Quantities", margin, y);
  y += 6;
  doc.setFontSize(9);
  doc.setFont("helvetica", "normal");

  const tableX = margin;
  const colWidths = [70, 25, 20, 25, 30];
  const headers = ["Description", "Quantity", "Unit", "Unit Rate", "Amount"];

  // Table header
  let x = tableX;
  headers.forEach((h, i) => {
    doc.text(h, x + 2, y);
    x += colWidths[i];
  });
  y += 4;
  doc.line(margin, y, pageWidth - margin, y);
  y += 3;

  function tableRow(desc, qty, unit, rate, amt){
    let x = tableX;
    const lineH = 5;
    doc.text(desc, x + 2, y);
    x += colWidths[0];
    doc.text(String(qty), x + 2, y);
    x += colWidths[1];
    doc.text(unit, x + 2, y);
    x += colWidths[2];
    doc.text(rate, x + 2, y);
    x += colWidths[3];
    doc.text(amt, x + 2, y);
    y += lineH;
    if(y > pageHeight - 20){
      doc.addPage();
      y = margin;
    }
  }

  // Example computed rows (no actual cost rates yet; placeholders)
  tableRow("Sanitary Pipes", "-", "m", "-", "-");
  tableRow("Sanitary Manholes", data.sanitary.manholes, "units", "-", "-");
  tableRow("Storm Drain Pipes", "-", "m", "-", "-");
  tableRow("Catch Basins", data.storm.catchBasins, "units", "-", "-");
  tableRow("Storm Manholes", data.storm.manholes, "units", "-", "-");
  tableRow("Misc. Fittings", data.sanitary.fittings + data.storm.fittings, "pcs", "-", "-");

  y += 2;
  doc.line(margin, y, pageWidth - margin, y);
  y += 6;
  doc.setFont("helvetica", "bold");
  doc.text("Subtotal (Materials & Labor): __________________________", margin, y);
  y += 8;
  doc.text("Overheads & Profit: __________________________", margin, y);
  y += 8;
  doc.text("Total Estimated Cost: __________________________", margin, y);
  y += 10;

  // ===== Sanitary System Summary =====
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("Sanitary System Summary", margin, y);
  y += 6;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  const san = data.sanitary;
  const units = unitSystemEl.value;
  const sanSizeDisplay = units === "metric"
      ? `${Math.round(san.pipeSize_mm)} mm`
      : `${(san.pipeSize_mm / 25.4).toFixed(2)} in`;
  doc.text(`Pipe Size: ${sanSizeDisplay}`, margin, y); y += 5;
  doc.text(`Manholes: ${san.manholes}`, margin, y); y += 5;
  doc.text(`Fittings (est.): ${san.fittings}`, margin, y); y += 8;

  // ===== Storm Drain System Summary =====
  doc.setFont("helvetica", "bold");
  doc.text("Storm Drain System Summary", margin, y);
  y += 6;
  doc.setFont("helvetica", "normal");
  const storm = data.storm;
  const flowDisplay =
      units === "metric"
        ? `${storm.runoff_Ls.toFixed(2)} L/s`
        : `${(storm.runoff_Ls * 15.8503).toFixed(2)} gpm`;
  const stormSizeDisplay =
      units === "metric"
        ? `${Math.round(storm.pipeSize_mm)} mm`
        : `${(storm.pipeSize_mm / 25.4).toFixed(2)} in`;
  doc.text(`Catchment Area: ${storm.catchmentArea_m2.toFixed(2)} m²`, margin, y); y += 5;
  doc.text(`Runoff: ${flowDisplay}`, margin, y); y += 5;
  doc.text(`Pipe Size: ${stormSizeDisplay}`, margin, y); y += 5;
  doc.text(`Catch Basins: ${storm.catchBasins}`, margin, y); y += 8;

  // ===== Labor Requirements =====
  const labor = data.labor;
  doc.setFont("helvetica", "bold");
  doc.text("Labor Requirements Summary", margin, y);
  y += 6;
  doc.setFont("helvetica", "normal");
  doc.text(`Plumbers: ${labor.numPlumbers}`, margin, y); y += 5;
  doc.text(`Helpers: ${labor.numHelpers}`, margin, y); y += 5;
  doc.text(`Total Labor Days: ${labor.totalDays.toFixed(2)}`, margin, y); y += 5;
  doc.text(`Total Labor Hours: ${labor.totalLaborHours.toFixed(1)}`, margin, y); y += 5;
  doc.text(`Plumber Hours: ${labor.plumberHours.toFixed(1)}`, margin, y); y += 5;
  doc.text(`Helper Hours: ${labor.helperHours.toFixed(1)}`, margin, y); y += 10;

  // Footer (page numbering)
  const totalPages = doc.internal.getNumberOfPages();
  for(let i=1; i<=totalPages; i++){
    doc.setPage(i);
    const pageStr = `Page ${i} of ${totalPages}`;
    doc.setFontSize(9);
    doc.text(pageStr, pageWidth - margin, pageHeight - 10, { align: "right" });
  }

  doc.save("Sanitary_Storm_Report.pdf");
}
</script>

</body>
</html>
