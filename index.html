<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sanitary & Storm Drain Calculator</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, sans-serif;
    background: #f9fafb;
    margin: 0;
    padding: 0;
  }
  header {
    background: #1a4a7a;
    color: white;
    padding: 16px;
    text-align: center;
    font-size: 1.4em;
    font-weight: 600;
  }
  .tab {
    overflow: hidden;
    background-color: #f1f1f1;
    display: flex;
    justify-content: center;
  }
  .tab button {
    background-color: inherit;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 12px 20px;
    transition: 0.3s;
    font-size: 16px;
  }
  .tab button:hover {
    background-color: #ddd;
  }
  .tab button.active {
    background-color: #1a4a7a;
    color: white;
  }
  .tabcontent {
    display: none;
    padding: 20px;
    background: white;
    border-top: none;
  }
  .input-group {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }
  .input-group label {
    flex: 1 1 240px;
    min-width: 200px;
    font-weight: 500;
  }
  .input-group input, .input-group select {
    flex: 1 1 150px;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .btn {
    background: #1a4a7a;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 10px 16px;
    margin: 8px 0;
    cursor: pointer;
  }
  .btn:hover {
    background: #15537f;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  table, th, td {
    border: 1px solid #ddd;
  }
  th {
    background: #f2f2f2;
    text-align: center;
  }
  td, th {
    padding: 8px;
  }
  .section-title {
    font-size: 1.2em;
    font-weight: 600;
    margin: 20px 0 10px;
    color: #1a4a7a;
  }
</style>
</head>
<body>

<header>Sanitary & Storm Drain Calculator</header>

<div class="tab">
  <button class="tablinks active" onclick="openTab(event, 'sanitary')">Sanitary System</button>
  <button class="tablinks" onclick="openTab(event, 'storm')">Storm Drain System</button>
  <button class="tablinks" onclick="openTab(event, 'labor')">Labor & Costing</button>
  <button class="tablinks" onclick="openTab(event, 'report')">Report</button>
</div>

<!-- SANITARY TAB -->
<div id="sanitary" class="tabcontent" style="display:block">
  <div class="section-title">Sanitary System Inputs</div>

  <div class="input-group">
    <label for="fixtureUnits">Total Fixture Units</label>
    <input type="number" id="fixtureUnits" placeholder="e.g. 120">
  </div>

  <div class="input-group">
    <label for="sanitaryPipeLength">Total Pipe Length (m)</label>
    <input type="number" id="sanitaryPipeLength" placeholder="e.g. 80">
  </div>

  <!-- Accessory Overrides -->
  <div class="input-group">
    <label for="numTraps">Traps (optional override)</label>
    <input type="number" id="numTraps" placeholder="Leave blank for default">
  </div>

  <div class="input-group">
    <label for="numCleanouts">Cleanouts (optional override)</label>
    <input type="number" id="numCleanouts" placeholder="Leave blank for default (30 m rule)">
  </div>

  <div class="input-group">
    <label for="numSanManholes">Manholes (optional override)</label>
    <input type="number" id="numSanManholes" placeholder="Leave blank for default (50 m rule)">
  </div>

  <div class="input-group">
    <label for="numSanFittings">Fittings (optional override)</label>
    <input type="number" id="numSanFittings" placeholder="Leave blank for default">
  </div>

  <button class="btn" onclick="calculateSanitary()">Calculate Sanitary System</button>

  <div id="sanitaryResults" style="margin-top:20px;"></div>
</div>

<!-- STORM TAB -->
<div id="storm" class="tabcontent">
  <div class="section-title">Storm Drain System Inputs</div>

  <div class="input-group">
    <label for="catchmentArea">Catchment Area (m²)</label>
    <input type="number" id="catchmentArea" placeholder="e.g. 250">
  </div>

  <div class="input-group">
    <label for="rainIntensity">Rainfall Intensity (mm/hr)</label>
    <input type="number" id="rainIntensity" placeholder="Leave blank to use preset">
  </div>

  <div class="input-group">
    <label for="rainPreset">Rainfall Preset</label>
    <select id="rainPreset">
      <option value="">-- Select Preset (optional) --</option>
      <option value="50">Light (50 mm/hr)</option>
      <option value="75">Medium (75 mm/hr)</option>
      <option value="100">Heavy (100 mm/hr)</option>
    </select>
  </div>

  <div class="input-group">
    <label for="stormPipeLength">Total Pipe Length (m)</label>
    <input type="number" id="stormPipeLength" placeholder="e.g. 60">
  </div>

  <!-- Accessory Overrides -->
  <div class="input-group">
    <label for="numCatchBasins">Catch Basins (optional override)</label>
    <input type="number" id="numCatchBasins" placeholder="Leave blank for default">
  </div>

  <div class="input-group">
    <label for="numStormManholes">Manholes (optional override)</label>
    <input type="number" id="numStormManholes" placeholder="Leave blank for default (50 m rule)">
  </div>

  <div class="input-group">
    <label for="numStormFittings">Fittings (optional override)</label>
    <input type="number" id="numStormFittings" placeholder="Leave blank for default">
  </div>

  <button class="btn" onclick="calculateStorm()">Calculate Storm Drain System</button>

  <div id="stormResults" style="margin-top:20px;"></div>
</div>

<!-- LABOR TAB -->
<div id="labor" class="tabcontent">
  <div class="section-title">Labor & Costing Inputs</div>

  <div class="input-group">
    <label for="laborRatePlumber">Plumber Daily Rate (₱)</label>
    <input type="number" id="laborRatePlumber" placeholder="e.g. 1000">
  </div>

  <div class="input-group">
    <label for="laborRateHelper">Helper Daily Rate (₱)</label>
    <input type="number" id="laborRateHelper" placeholder="e.g. 700">
  </div>

  <div class="input-group">
    <label for="productivityPipe">Productivity – Pipe Laying (m/day)</label>
    <input type="number" id="productivityPipe" placeholder="e.g. 15">
  </div>

  <div class="input-group">
    <label for="productivityManhole">Productivity – Manhole Installation (units/day)</label>
    <input type="number" id="productivityManhole" placeholder="e.g. 1">
  </div>

  <div class="input-group">
    <label for="productivityFitting">Productivity – Fitting Installation (pcs/day)</label>
    <input type="number" id="productivityFitting" placeholder="e.g. 20">
  </div>

  <button class="btn" onclick="calculateLabor()">Compute Labor & Cost</button>
  <div id="laborResults" style="margin-top:20px;"></div>
</div>

<!-- REPORT TAB -->
<div id="report" class="tabcontent">
  <div class="section-title">Generate PDF Report</div>
  <button class="btn" onclick="exportToPDF()">Export to PDF</button>
  <div id="reportNote" style="margin-top:10px;font-size:0.9em;color:#555">
    The PDF will include all summaries and multi-page support.
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script>
/* ================================
  Part 2 — JavaScript for calculator
  - accessory overrides (if blank -> defaults)
  - rainfall presets with manual override
  - labor allocation (pipe 60%, manhole 25%, fittings 15%)
  - improved PDF export with boxed summaries and auto-pagination
  ================================ */

/* ---------- Constants ---------- */
const DEFAULT_CLEANOUT_SPACING_M = 30;
const DEFAULT_MANHOLE_SPACING_M = 50;
const LABOR_ALLOCATION = { pipe: 0.60, manhole: 0.25, fittings: 0.15 };
const RAIN_PRESETS = { light: 50, medium: 75, heavy: 100 };
const DEFAULT_DAILY_HOURS = 8;
const EPS = 1e-9;

/* ---------- Global state ---------- */
let sanitaryResults = null;
let stormResults = null;
let laborResults = null;

/* ---------- Utility helpers ---------- */
function q(id){ return document.getElementById(id); }
function toNum(v, fallback=0){ const n = Number(v); return (isNaN(n) ? fallback : n); }
function clampNonNeg(n){ return (isNaN(n) || n < 0) ? 0 : n; }
function fmt(n, dp=2){ if(isNaN(n)) return ''; return Number(Math.round((n+Number.EPSILON)*Math.pow(10,dp))/Math.pow(10,dp)).toLocaleString(undefined, {minimumFractionDigits: dp, maximumFractionDigits: dp}); }
function safeDivide(a,b){ a = Number(a); b = Number(b); if(isNaN(a)||isNaN(b)||Math.abs(b) < EPS) return 0; return a/b; }

/* ---------- Tab handling ---------- */
function openTab(evt, tabName){
  const tabcontent = document.getElementsByClassName("tabcontent");
  for (let i=0;i<tabcontent.length;i++) tabcontent[i].style.display = "none";
  const tablinks = document.getElementsByClassName("tablinks");
  for (let i=0;i<tablinks.length;i++) tablinks[i].classList.remove("active");
  document.getElementById(tabName).style.display = "block";
  if (evt && evt.currentTarget) evt.currentTarget.classList.add("active");
}

/* ---------- Sanitary calculation ---------- */
function calculateSanitary(){
  // Read inputs
  const fixtureUnits = clampNonNeg( toNum(q('fixtureUnits').value, 0) );
  const sanPipeLength = clampNonNeg( toNum(q('sanitaryPipeLength').value, 0) );

  // Accessory overrides (optional)
  const trapsOverride = q('numTraps').value.trim();
  const cleanoutsOverride = q('numCleanouts').value.trim();
  const manholesOverride = q('numSanManholes').value.trim();
  const fittingsOverride = q('numSanFittings').value.trim();

  // Defaults / estimation logic
  // Traps: estimate as one trap per ~6 fixture units (heuristic); min 1 if there is pipe length or fixture units
  let trapsDefault = 0;
  if (fixtureUnits > 0) trapsDefault = Math.max(1, Math.ceil(fixtureUnits / 6));
  else if (sanPipeLength > 0) trapsDefault = 1;

  // Cleanouts & manholes by spacing
  let cleanoutsDefault = Math.max(0, Math.ceil(sanPipeLength / DEFAULT_CLEANOUT_SPACING_M));
  let manholesDefault = Math.max(0, Math.ceil(sanPipeLength / DEFAULT_MANHOLE_SPACING_M));

  // Fittings estimate: rough - 1 fitting per 10 m
  let fittingsDefault = Math.max(0, Math.ceil(sanPipeLength / 10));

  // Use overrides if provided (non-empty & numeric)
  const traps = (trapsOverride !== '') ? Math.max(0, Math.round(toNum(trapsOverride))) : trapsDefault;
  const cleanouts = (cleanoutsOverride !== '') ? Math.max(0, Math.round(toNum(cleanoutsOverride))) : cleanoutsDefault;
  const manholes = (manholesOverride !== '') ? Math.max(0, Math.round(toNum(manholesOverride))) : manholesDefault;
  const fittings = (fittingsOverride !== '') ? Math.max(0, Math.round(toNum(fittingsOverride))) : fittingsDefault;

  // Drainage load (simple heuristic): FU * 0.8 L/s
  const drainageLoad_Ls = fixtureUnits * 0.8;

  // Pipe sizing heuristic (same simple map)
  let pipeSize = 50;
  if (fixtureUnits <= 21) pipeSize = 50;
  else if (fixtureUnits <= 40) pipeSize = 75;
  else if (fixtureUnits <= 180) pipeSize = 100;
  else if (fixtureUnits <= 800) pipeSize = 150;
  else pipeSize = 200;

  sanitaryResults = {
    fixtureUnits,
    drainageLoad_Ls,
    pipeSize,
    pipeLength_m: sanPipeLength,
    traps, cleanouts, manholes, fittings
  };

  // Display results
  const out = q('sanitaryResults');
  out.innerHTML = `
    <h3>Sanitary Results</h3>
    <p><strong>Total Fixture Units:</strong> ${fmt(fixtureUnits,0)}</p>
    <p><strong>Drainage Load:</strong> ${fmt(drainageLoad_Ls,2)} L/s</p>
    <p><strong>Recommended Pipe Size:</strong> ${pipeSize} mm</p>
    <p><strong>Pipe Length:</strong> ${fmt(sanPipeLength,1)} m</p>
    <p><strong>Accessories (used — override if provided):</strong></p>
    <ul>
      <li>Traps: ${traps}</li>
      <li>Cleanouts: ${cleanouts} ${cleanoutsOverride? '(user override)':''}</li>
      <li>Manholes: ${manholes} ${manholesOverride? '(user override)':''}</li>
      <li>Fittings: ${fittings} ${fittingsOverride? '(user override)':''}</li>
    </ul>
  `;
  return sanitaryResults;
}

/* ---------- Storm calculation ---------- */
function calculateStorm(){
  let area = clampNonNeg( toNum(q('catchmentArea').value, 0) );
  let intensityInput = q('rainIntensity').value.trim();
  const presetVal = q('rainPreset').value;
  let stormPipeLength = clampNonNeg( toNum(q('stormPipeLength').value, 0) );

  // Determine intensity: manual > preset > default medium
  let intensity_mmhr = 0;
  if (intensityInput !== '') intensity_mmhr = clampNonNeg( toNum(intensityInput, 0) );
  else if (presetVal !== '') intensity_mmhr = clampNonNeg( toNum(presetVal, RAIN_PRESETS.medium) );
  else intensity_mmhr = RAIN_PRESETS.medium;

  // Accessory overrides
  const catchBasinsOverride = q('numCatchBasins').value.trim();
  const stormManholesOverride = q('numStormManholes').value.trim();
  const stormFittingsOverride = q('numStormFittings').value.trim();

  // Compute runoff (Q L/s) = C * I(mm/hr) * A(m2) / 360. We'll use C = 0.9 default
  const C = 0.9;
  const runoff_Ls = C * intensity_mmhr * area / 360;

  // Pipe sizing heuristic based on runoff
  let pipeSize = 75;
  if (runoff_Ls <= 1.2) pipeSize = 75;
  else if (runoff_Ls <= 2.5) pipeSize = 100;
  else if (runoff_Ls <= 5.3) pipeSize = 150;
  else if (runoff_Ls <= 15) pipeSize = 200;
  else pipeSize = 250;

  // Defaults for accessories
  const catchBasinsDefault = Math.max(0, Math.ceil(stormPipeLength / 60));
  const manholesDefault = Math.max(0, Math.ceil(stormPipeLength / DEFAULT_MANHOLE_SPACING_M));
  const fittingsDefault = Math.max(0, Math.ceil(stormPipeLength / 10));

  const catchBasins = (catchBasinsOverride !== '') ? Math.max(0, Math.round(toNum(catchBasinsOverride))) : catchBasinsDefault;
  const manholes = (stormManholesOverride !== '') ? Math.max(0, Math.round(toNum(stormManholesOverride))) : manholesDefault;
  const fittings = (stormFittingsOverride !== '') ? Math.max(0, Math.round(toNum(stormFittingsOverride))) : fittingsDefault;

  stormResults = {
    area_m2: area,
    intensity_mmhr,
    runoff_Ls,
    pipeSize,
    pipeLength_m: stormPipeLength,
    catchBasins, manholes, fittings
  };

  // Display
  const out = q('stormResults');
  out.innerHTML = `
    <h3>Storm Results</h3>
    <p><strong>Total Area:</strong> ${fmt(area,2)} m²</p>
    <p><strong>Rainfall Intensity:</strong> ${fmt(intensity_mmhr,1)} mm/hr</p>
    <p><strong>Runoff:</strong> ${fmt(runoff_Ls,2)} L/s</p>
    <p><strong>Recommended Pipe Size:</strong> ${pipeSize} mm</p>
    <p><strong>Pipe Length:</strong> ${fmt(stormPipeLength,1)} m</p>
    <p><strong>Accessories (used — override if provided):</strong></p>
    <ul>
      <li>Catch Basins: ${catchBasins} ${catchBasinsOverride? '(user override)':''}</li>
      <li>Manholes: ${manholes} ${stormManholesOverride? '(user override)':''}</li>
      <li>Fittings: ${fittings} ${stormFittingsOverride? '(user override)':''}</li>
    </ul>
  `;
  return stormResults;
}

/* ---------- Labor & Cost calculation ---------- */
function calculateLabor(){
  if (!sanitaryResults || !stormResults){
    alert('Please run the Sanitary and Storm calculations first.');
    return;
  }

  // Inputs: daily rates and productivities
  const plumberDaily = clampNonNeg( toNum(q('laborRatePlumber').value, 0) );
  const helperDaily = clampNonNeg( toNum(q('laborRateHelper').value, 0) );
  let prodPipe = clampNonNeg( toNum(q('productivityPipe').value, 0) );
  let prodManhole = clampNonNeg( toNum(q('productivityManhole').value, 0) );
  let prodFitting = clampNonNeg( toNum(q('productivityFitting').value, 0) );

  // Basic guards: if productivity is zero or missing, set conservative defaults
  if (prodPipe <= 0) prodPipe = 10; // m/day
  if (prodManhole <= 0) prodManhole = 0.8; // units/day
  if (prodFitting <= 0) prodFitting = 20; // pcs/day

  // Sum activity quantities
  const totalPipeLength = (sanitaryResults.pipeLength_m || 0) + (stormResults.pipeLength_m || 0);
  const totalManholes = (sanitaryResults.manholes || 0) + (stormResults.manholes || 0);
  const totalFittings = (sanitaryResults.fittings || 0) + (stormResults.fittings || 0);

  // Days per activity with guards
  const daysPipe = prodPipe > EPS ? totalPipeLength / prodPipe : 0;
  const daysManhole = prodManhole > EPS ? totalManholes / prodManhole : 0;
  const daysFitting = prodFitting > EPS ? totalFittings / prodFitting : 0;

  const totalLaborDays = daysPipe + daysManhole + daysFitting;
  const totalLaborHours = totalLaborDays * DEFAULT_DAILY_HOURS;

  // Allocate hours by task using professional split (pipe/manhole/fittings)
  // Then map to plumber/helper cost assuming plumbers perform 60% of work and helpers 40%
  const allocatedHoursPipe = totalLaborHours * LABOR_ALLOCATION.pipe;
  const allocatedHoursManhole = totalLaborHours * LABOR_ALLOCATION.manhole;
  const allocatedHoursFitting = totalLaborHours * LABOR_ALLOCATION.fittings;

  const totalAllocatedHours = allocatedHoursPipe + allocatedHoursManhole + allocatedHoursFitting;

  // For costing, assume plumber performs 60% of allocated hours (by default) and helper 40%
  const plumberHours = totalAllocatedHours * 0.60;
  const helperHours = totalAllocatedHours * 0.40;

  // Convert hours to days using DEFAULT_DAILY_HOURS, then multiply by daily rates
  const plumberDays = plumberHours / DEFAULT_DAILY_HOURS;
  const helperDays = helperHours / DEFAULT_DAILY_HOURS;
  const plumberCost = plumberDays * plumberDaily;
  const helperCost = helperDays * helperDaily;
  const totalLaborCost = plumberCost + helperCost;

  laborResults = {
    daysPipe, daysManhole, daysFitting,
    totalLaborDays, totalLaborHours,
    allocatedHoursPipe, allocatedHoursManhole, allocatedHoursFitting,
    plumberHours, helperHours, plumberCost, helperCost, totalLaborCost
  };

  // Display
  const out = q('laborResults');
  out.innerHTML = `
    <h3>Labor Estimate</h3>
    <p><strong>Total Labor Days (sum of activities):</strong> ${fmt(totalLaborDays,2)} days</p>
    <p><strong>Total Labor Hours:</strong> ${fmt(totalLaborHours,1)} hrs</p>
    <p><strong>Plumber Hours (est.):</strong> ${fmt(plumberHours,1)} hrs</p>
    <p><strong>Helper Hours (est.):</strong> ${fmt(helperHours,1)} hrs</p>
    <p><strong>Total Labor Cost:</strong> ${plumberCost>0 || helperCost>0 ? ( '₱ ' + fmt(plumberCost + helperCost,2) ) : '₱ 0.00'}</p>
    <p><em>Notes: labor allocation uses professional split: Pipe 60%, Manhole 25%, Fittings 15%.</em></p>
  `;

  return laborResults;
}

/* ---------- PDF Export ---------- */
async function exportToPDF(){
  // Require that calculations were run
  if (!sanitaryResults || !stormResults || !laborResults){
    alert('Please run Sanitary, Storm, and Labor calculations before exporting PDF.');
    return;
  }

  // load jspdf
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  doc.setFont('helvetica');

  const leftMargin = 40;
  const topMargin = 40;
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const rightLimit = pageWidth - leftMargin;
  const bottomLimit = pageHeight - 60;
  let y = topMargin;

  function newPageIfNeeded(linesNeeded = 80){
    if (y + linesNeeded > bottomLimit){
      doc.addPage();
      y = topMargin;
    }
  }

  // Header
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text("Sanitary & Storm Drain Report", leftMargin, y);
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  y += 18;

  const projectTitle = 'Project';
  doc.text(`Project: ${projectTitle}`, leftMargin, y);
  doc.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth - leftMargin - 120, y);
  y += 16;

  // Bill of Quantities (simple table)
  doc.setFont(undefined,'bold');
  doc.setFontSize(12);
  doc.text('Bill of Quantities', leftMargin, y);
  doc.setFont(undefined,'normal');
  y += 10;

  // Build BOQ rows using accessory overrides if provided
  const rows = [];
  // Sanitary items
  rows.push(['Sanitary Pipes', sanitaryResults.pipeLength_m ? fmt(sanitaryResults.pipeLength_m,1) : '', 'm', '', '']);
  rows.push(['Sanitary Traps', sanitaryResults.traps, 'pcs', '', '']);
  rows.push(['Sanitary Cleanouts', sanitaryResults.cleanouts, 'pcs', '', '']);
  rows.push(['Sanitary Manholes', sanitaryResults.manholes, 'pcs', '', '']);
  rows.push(['Sanitary Fittings', sanitaryResults.fittings, 'pcs', '', '']);

  // Storm items
  rows.push(['Storm Pipes', stormResults.pipeLength_m ? fmt(stormResults.pipeLength_m,1) : '', 'm', '', '']);
  rows.push(['Catch Basins', stormResults.catchBasins, 'pcs', '', '']);
  rows.push(['Storm Manholes', stormResults.manholes, 'pcs', '', '']);
  rows.push(['Storm Fittings', stormResults.fittings, 'pcs', '', '']);

  // Add a summary total row placeholder (amounts not calculated here)
  rows.push(['TOTAL PROJECT COST', '', '', '', '']);

  // Use autoTable for the BOQ
  doc.autoTable({
    startY: y,
    head: [['Description','Qty','Unit','Unit Rate','Amount']],
    body: rows,
    styles: { fontSize: 10, cellPadding: 6 },
    columnStyles: {
      0: { cellWidth: 220 },
      1: { halign: 'center', cellWidth: 60 },
      2: { halign: 'center', cellWidth: 60 },
      3: { halign: 'right', cellWidth: 100 },
      4: { halign: 'right', cellWidth: 100 }
    },
    didDrawPage: function(data){
      // page number only
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text(`Page ${data.pageNumber}`, pageWidth - leftMargin - 30, pageHeight - 30);
    }
  });

  y = doc.autoTable.previous.finalY + 18;

  /* ========== SUMMARY BOXES (improved padding & wrapping) ========== */
  // function to draw a summary box for a lines array
  function drawSummaryBox(title, linesArray){
    newPageIfNeeded(120);
    const boxPaddingTop = 8;
    const boxPaddingBottom = 10;
    const boxPaddingSides = 8;
    const usableWidth = pageWidth - leftMargin*2;
    let curY = y;

    // title
    doc.setFont(undefined, 'bold');
    doc.setFontSize(12);
    doc.text(title, leftMargin, curY);
    doc.setFont(undefined, 'normal');
    curY += 14;
    const boxStartY = curY - boxPaddingTop;

    // content lines (wrap long lines)
    doc.setFontSize(10);
    for (const ln of linesArray){
      const wrapped = doc.splitTextToSize(ln, usableWidth - boxPaddingSides*2);
      doc.text(wrapped, leftMargin + boxPaddingSides, curY);
      curY += wrapped.length * 12;
    }

    const boxEndY = curY + boxPaddingBottom;
    // subtle rectangle
    doc.setDrawColor(180);
    doc.setLineWidth(0.7);
    doc.rect(leftMargin - boxPaddingSides, boxStartY - boxPaddingTop, usableWidth + boxPaddingSides*2, (boxEndY - boxStartY), 'S');

    y = boxEndY + 14;
  }

  // Sanitary summary lines
  const sanLines = [
    `Total Fixture Units: ${fmt(sanitaryResults.fixtureUnits,0)}`,
    `Drainage Load: ${fmt(sanitaryResults.drainageLoad_Ls,2)} L/s`,
    `Pipe Size: ${sanitaryResults.pipeSize} mm`,
    `Pipe Length: ${fmt(sanitaryResults.pipeLength_m,1)} m`,
    `Pipe Quantity (approx): ${sanitaryResults.pipeLength_m ? Math.ceil(sanitaryResults.pipeLength_m/6) + ' pcs (using 6 m pipe)' : 'N/A'}`,
    `Traps: ${sanitaryResults.traps}`,
    `Cleanouts: ${sanitaryResults.cleanouts}`,
    `Manholes: ${sanitaryResults.manholes}`,
    `Fittings: ${sanitaryResults.fittings}`
  ];

  drawSummaryBox('Sanitary System Summary', sanLines);

  // Storm summary lines
  const stormLines = [
    `Total Area: ${fmt(stormResults.area_m2,2)} m²`,
    `Rainfall Intensity used: ${fmt(stormResults.intensity_mmhr,1)} mm/hr`,
    `Runoff: ${fmt(stormResults.runoff_Ls,2)} L/s`,
    `Pipe Size: ${stormResults.pipeSize} mm`,
    `Pipe Length: ${fmt(stormResults.pipeLength_m,1)} m`,
    `Catch Basins: ${stormResults.catchBasins}`,
    `Manholes: ${stormResults.manholes}`,
    `Fittings: ${stormResults.fittings}`
  ];

  drawSummaryBox('Storm Drain Summary', stormLines);

  // Labor summary lines
  const laborLines = [
    `Total Labor Days (sum of activities): ${fmt(laborResults.totalLaborDays,2)} days`,
    `Total Labor Hours: ${fmt(laborResults.totalLaborHours,1)} hrs`,
    `Plumber Hours (est.): ${fmt(laborResults.plumberHours,1)} hrs`,
    `Helper Hours (est.): ${fmt(laborResults.helperHours,1)} hrs`,
    `Total Labor Cost: ${laborResults.totalLaborCost ? ('₱ ' + fmt(laborResults.totalLaborCost,2)) : '₱ 0.00'}`,
    `Productivity rates used: Pipe ${q('productivityPipe').value || '—'} m/day; Manhole ${q('productivityManhole').value || '—'} units/day; Fitting ${q('productivityFitting').value || '—'} pcs/day`
  ];

  drawSummaryBox('Labor Requirements', laborLines);

  // Save file
  const fileName = (document.title || 'project').replace(/[^a-z0-9]/gi, '_') + '_Report.pdf';
  doc.save(fileName);
}

/* ---------- Initialize small UI helpers ---------- */
(function init(){
  // hook tab buttons: they already call openTab inline in Part 1, so nothing necessary here
  // but ensure default values for rain preset reflect medium if empty
  q('rainPreset').addEventListener('change', function(){
    // if user picks preset, update rainIntensity only if empty
    if (this.value && q('rainIntensity').value.trim() === ''){
      q('rainIntensity').value = this.value;
    }
  });

  // Prevent negative inputs visually (simple)
  const numericIds = ['fixtureUnits','sanitaryPipeLength','numTraps','numCleanouts','numSanManholes','numSanFittings','catchmentArea','rainIntensity','stormPipeLength','numCatchBasins','numStormManholes','numStormFittings','laborRatePlumber','laborRateHelper','productivityPipe','productivityManhole','productivityFitting'];
  numericIds.forEach(id=>{
    const el = q(id);
    if (!el) return;
    el.addEventListener('input', ()=> {
      if (el.value !== '' && Number(el.value) < 0) el.value = Math.abs(Number(el.value));
    });
  });
})();
</script>
